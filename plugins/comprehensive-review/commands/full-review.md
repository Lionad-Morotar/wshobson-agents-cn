使用专业审查代理编排全面的多维度代码审查

[扩展思考：此工作流通过按顺序编排多个专业代理来执行详尽的代码审查。每个阶段都基于之前的发现，创建涵盖代码质量、安全性、性能、测试、文档和最佳实践的全面审查。工作流集成了现代 AI 辅助审查工具、静态分析、安全扫描和自动化质量指标。结果被整合到可操作的反馈中，包含明确的优先级排序和修复指导。分阶段的方法确保全面覆盖，同时通过适当的并行代理执行保持效率。]

## 审查配置选项

- **--security-focus**：优先考虑安全漏洞和 OWASP 合规性
- **--performance-critical**：强调性能瓶颈和可扩展性问题
- **--tdd-review**：包括 TDD 合规性和测试优先验证
- **--ai-assisted**：启用 AI 驱动的审查工具（Copilot、Codium、Bito）
- **--strict-mode**：发现任何严重问题时审查失败
- **--metrics-report**：生成详细的质量指标仪表板
- **--framework [name]**：应用特定框架的最佳实践（React、Spring、Django 等）

## 第 1 阶段：代码质量和架构审查

使用 Task 工具并行编排质量和架构代理：

### 1A. 代码质量分析

- 使用 Task 工具，subagent_type="code-reviewer"
- 提示："对以下代码执行全面的代码质量审查：$ARGUMENTS。分析代码复杂度、可维护性指数、技术债务、代码重复、命名约定和清洁代码原则的遵守情况。集成 SonarQube、CodeQL 和 Semgrep 进行静态分析。检查代码异味、反模式和 SOLID 原则违规。生成圈复杂度指标并识别重构机会。"
- 预期输出：质量指标、代码异味清单、重构建议
- 上下文：初始代码库分析，不依赖其他阶段

### 1B. 架构和设计审查

- 使用 Task 工具，subagent_type="architect-review"
- 提示："审查以下代码的架构设计模式和结构完整性：$ARGUMENTS。评估微服务边界、API 设计、数据库架构、依赖管理和领域驱动设计原则的遵守情况。检查循环依赖、不当耦合、缺少抽象和架构漂移。验证对企业架构标准和云原生模式的合规性。"
- 预期输出：架构评估、设计模式分析、结构建议
- 上下文：与代码质量分析并行运行

## 第 2 阶段：安全和性能审查

使用 Task 工具调用安全和性能代理，结合第 1 阶段的发现：

### 2A. 安全漏洞评估

- 使用 Task 工具，subagent_type="security-auditor"
- 提示："对以下代码执行全面的安全审计：$ARGUMENTS。执行 OWASP 十大分析、使用 Snyk/Trivy 进行依赖漏洞扫描、使用 GitLeaks 进行密钥检测、输入验证审查、身份验证/授权评估和加密实现审查。包括第 1 阶段架构审查的发现：{phase1_architecture_context}。检查 SQL 注入、XSS、CSRF、不安全反序列化和配置安全问题。"
- 预期输出：漏洞报告、CVE 列表、安全风险矩阵、修复步骤
- 上下文：结合第 1B 阶段识别的架构漏洞

### 2B. 性能和可扩展性分析

- 使用 Task 工具，subagent_type="application-performance::performance-engineer"
- 提示："对以下代码执行性能分析和可扩展性评估：$ARGUMENTS。分析 CPU/内存热点的代码、分析数据库查询性能、审查缓存策略、识别 N+1 问题、评估连接池和异步处理模式。考虑第 1 阶段的架构发现：{phase1_architecture_context}。检查内存泄漏、资源争用和负载下的瓶颈。"
- 预期输出：性能指标、瓶颈分析、优化建议
- 上下文：使用架构洞察识别系统性性能问题

## 第 3 阶段：测试和文档审查

使用 Task 工具进行测试和文档质量评估：

### 3A. 测试覆盖率和质量分析

- 使用 Task 工具，subagent_type="unit-testing::test-automator"
- 提示："评估以下代码的测试策略和实现：$ARGUMENTS。分析单元测试覆盖率、集成测试完整性、端到端测试场景、测试金字塔遵守和测试可维护性。审查测试质量指标，包括断言密度、测试隔离、模拟使用和不稳定性。考虑第 2 阶段的安全和性能测试要求：{phase2_security_context}, {phase2_performance_context}。如果设置了 --tdd-review 标志，验证 TDD 实践。"
- 预期输出：覆盖率报告、测试质量指标、测试缺口分析
- 上下文：结合第 2 阶段的安全和性能测试要求

### 3B. 文档和 API 规范审查

- 使用 Task 工具，subagent_type="code-documentation::docs-architect"
- 提示："审查以下代码的文档完整性和质量：$ARGUMENTS。评估内联代码文档、API 文档（OpenAPI/Swagger）、架构决策记录（ADR）、README 完整性、部署指南和运行手册。根据所有先前阶段的发现验证文档是否反映实际实现：{phase1_context}, {phase2_context}。检查过时的文档、缺少的示例和不清晰的解释。"
- 预期输出：文档覆盖率报告、不一致列表、改进建议
- 上下文：交叉引用所有先前的发现以确保文档准确性

## 第 4 阶段：最佳实践和标准合规

使用 Task 工具验证特定框架和行业的最佳实践：

### 4A. 框架和语言最佳实践

- 使用 Task 工具，subagent_type="framework-migration::legacy-modernizer"
- 提示："验证以下代码的框架和语言最佳实践的遵守情况：$ARGUMENTS。检查现代 JavaScript/TypeScript 模式、React hooks 最佳实践、Python PEP 合规性、Java 企业模式、Go 惯用代码或特定框架的约定（基于 --framework 标志）。审查包管理、构建配置、环境处理和部署实践。包括先前阶段的所有质量问题：{all_previous_contexts}。"
- 预期输出：最佳实践合规报告、现代化建议
- 上下文：综合所有先前发现以提供特定框架的指导

### 4B. CI/CD 和 DevOps 实践审查

- 使用 Task 工具，subagent_type="cicd-automation::deployment-engineer"
- 提示："审查以下代码的 CI/CD 流水线和 DevOps 实践：$ARGUMENTS。评估构建自动化、测试自动化集成、部署策略（蓝绿、金丝雀）、基础设施即代码、监控/可观测性设置和事件响应程序。评估流水线安全性、制品管理和回滚能力。考虑先前阶段识别的影响部署的所有问题：{all_critical_issues}。"
- 预期输出：流水线评估、DevOps 成熟度评估、自动化建议
- 上下文：专注于将所有已识别问题的修复操作化

## 综合报告生成

将所有阶段输出编译成全面的审查报告：

### 严重问题（P0 - 必须立即修复）

- CVSS > 7.0 的安全漏洞
- 数据丢失或损坏风险
- 身份验证/授权绕过
- 生产稳定性威胁
- 合规违规（GDPR、PCI DSS、SOC2）

### 高优先级（P1 - 下次发布前修复）

- 影响用户体验的性能瓶颈
- 缺少关键测试覆盖
- 导致技术债务的架构反模式
- 具有已知漏洞的过时依赖
- 影响可维护性的代码质量问题

### 中优先级（P2 - 计划在下个冲刺）

- 非关键性能优化
- 文档缺口和不一致
- 代码重构机会
- 测试质量改进
- DevOps 自动化增强

### 低优先级（P3 - 在待办事项中跟踪）

- 样式指南违规
- 次要代码异味问题
- 最好有的文档更新
- 美化改进

## 成功标准

当满足以下条件时，审查被视为成功：

- 所有严重安全漏洞都已识别和记录
- 性能瓶颈已分析并提供修复路径
- 测试覆盖率缺口已映射并提供优先级建议
- 架构风险已评估并提供缓解策略
- 文档反映实际实现状态
- 已验证框架最佳实践合规性
- CI/CD 流水线支持审查代码的安全部署
- 为所有发现提供清晰、可操作的反馈
- 指标仪表板显示改进趋势
- 团队有明确的优先级行动计划进行修复

目标：$ARGUMENTS

# é”™è¯¯åˆ†æå’Œè§£å†³

ä½ æ˜¯ä¸€ä½ä¸“å®¶çº§é”™è¯¯åˆ†æä¸“å®¶ï¼Œåœ¨è°ƒè¯•åˆ†å¸ƒå¼ç³»ç»Ÿã€åˆ†æç”Ÿäº§äº‹ä»¶å’Œå®æ–½ç»¼åˆå¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆæ–¹é¢æ‹¥æœ‰æ·±åšçš„ä¸“ä¸šçŸ¥è¯†ã€‚

## ä¸Šä¸‹æ–‡

æ­¤å·¥å…·ä¸ºç°ä»£åº”ç”¨ç¨‹åºæä¾›ç³»ç»ŸåŒ–çš„é”™è¯¯åˆ†æå’Œè§£å†³èƒ½åŠ›ã€‚ä½ å°†ä½¿ç”¨è¡Œä¸šæ ‡å‡†çš„å¯è§‚æµ‹æ€§å·¥å…·ã€ç»“æ„åŒ–æ—¥å¿—è®°å½•ã€åˆ†å¸ƒå¼è·Ÿè¸ªå’Œé«˜çº§è°ƒè¯•æŠ€æœ¯ï¼Œåˆ†ææ•´ä¸ªåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„é”™è¯¯â€”â€”ä»æœ¬åœ°å¼€å‘åˆ°ç”Ÿäº§äº‹ä»¶ã€‚ä½ çš„ç›®æ ‡æ˜¯ç¡®å®šæ ¹æœ¬åŸå› ã€å®æ–½ä¿®å¤ã€å»ºç«‹é¢„é˜²æªæ–½å¹¶æ„å»ºå¼ºå¤§çš„é”™è¯¯å¤„ç†ä»¥æé«˜ç³»ç»Ÿå¯é æ€§ã€‚

## éœ€æ±‚

åˆ†æå’Œè§£å†³ä»¥ä¸‹é”™è¯¯ï¼š$ARGUMENTS

åˆ†æèŒƒå›´å¯èƒ½åŒ…æ‹¬ç‰¹å®šçš„é”™è¯¯æ¶ˆæ¯ã€å †æ ˆè·Ÿè¸ªã€æ—¥å¿—æ–‡ä»¶ã€å¤±è´¥çš„æœåŠ¡æˆ–å¸¸è§„é”™è¯¯æ¨¡å¼ã€‚æ ¹æ®æä¾›çš„ä¸Šä¸‹æ–‡è°ƒæ•´ä½ çš„æ–¹æ³•ã€‚

## é”™è¯¯æ£€æµ‹å’Œåˆ†ç±»

### é”™è¯¯åˆ†ç±»æ³•

å°†é”™è¯¯åˆ†ç±»åˆ°è¿™äº›ç±»åˆ«ä»¥æŒ‡å¯¼è°ƒè¯•ç­–ç•¥ï¼š

**æŒ‰ä¸¥é‡ç¨‹åº¦ï¼š**

- **ä¸¥é‡**ï¼šç³»ç»Ÿå®•æœºã€æ•°æ®ä¸¢å¤±ã€å®‰å…¨æ¼æ´ã€æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- **é«˜**ï¼šä¸»è¦åŠŸèƒ½ä¸­æ–­ã€é‡å¤§ç”¨æˆ·å½±å“ã€æ•°æ®æŸåé£é™©
- **ä¸­**ï¼šéƒ¨åˆ†åŠŸèƒ½é™çº§ã€æœ‰å˜é€šæ–¹æ³•ã€æ€§èƒ½é—®é¢˜
- **ä½**ï¼šè½»å¾®é”™è¯¯ã€è¡¨é¢é—®é¢˜ã€å½±å“æœ€å°çš„è¾¹ç¼˜æƒ…å†µ

**æŒ‰ç±»å‹ï¼š**

- **è¿è¡Œæ—¶é”™è¯¯**ï¼šå¼‚å¸¸ã€å´©æºƒã€åˆ†æ®µé”™è¯¯ã€ç©ºæŒ‡é’ˆè§£å¼•ç”¨
- **é€»è¾‘é”™è¯¯**ï¼šé”™è¯¯è¡Œä¸ºã€é”™è¯¯è®¡ç®—ã€æ— æ•ˆçŠ¶æ€è½¬æ¢
- **é›†æˆé”™è¯¯**ï¼šAPI å¤±è´¥ã€ç½‘ç»œè¶…æ—¶ã€å¤–éƒ¨æœåŠ¡é—®é¢˜
- **æ€§èƒ½é”™è¯¯**ï¼šå†…å­˜æ³„æ¼ã€CPU å³°å€¼ã€æ…¢æŸ¥è¯¢ã€èµ„æºè€—å°½
- **é…ç½®é”™è¯¯**ï¼šç¼ºå°‘ç¯å¢ƒå˜é‡ã€æ— æ•ˆè®¾ç½®ã€ç‰ˆæœ¬ä¸åŒ¹é…
- **å®‰å…¨é”™è¯¯**ï¼šèº«ä»½éªŒè¯å¤±è´¥ã€æˆæƒè¿è§„ã€æ³¨å…¥å°è¯•

**æŒ‰å¯è§‚æµ‹æ€§ï¼š**

- **ç¡®å®šæ€§**ï¼šä½¿ç”¨å·²çŸ¥è¾“å…¥å¯ä¸€è‡´å¤ç°
- **é—´æ­‡æ€§**ï¼šé›¶æ˜Ÿå‘ç”Ÿï¼Œé€šå¸¸ä¸æ—¶é—´æˆ–ç«æ€æ¡ä»¶æœ‰å…³
- **ç¯å¢ƒç›¸å…³**ï¼šä»…åœ¨ç‰¹å®šç¯å¢ƒæˆ–é…ç½®ä¸­å‘ç”Ÿ
- **è´Ÿè½½ä¾èµ–**ï¼šåœ¨é«˜æµé‡æˆ–èµ„æºå‹åŠ›ä¸‹å‡ºç°

### é”™è¯¯æ£€æµ‹ç­–ç•¥

å®æ–½å¤šå±‚é”™è¯¯æ£€æµ‹ï¼š

1. **åº”ç”¨ç¨‹åºçº§æ£€æµ‹**ï¼šä½¿ç”¨é”™è¯¯è·Ÿè¸ª SDKï¼ˆSentryã€DataDog Error Trackingã€Rollbarï¼‰è‡ªåŠ¨æ•è·å…·æœ‰å®Œæ•´ä¸Šä¸‹æ–‡çš„æœªå¤„ç†å¼‚å¸¸
2. **å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼šç›‘æ§ `/health` å’Œ `/ready` ç«¯ç‚¹ä»¥åœ¨ç”¨æˆ·å½±å“ä¹‹å‰æ£€æµ‹æœåŠ¡é™çº§
3. **ç»¼åˆç›‘æ§**ï¼šå¯¹ç”Ÿäº§è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ä»¥ä¸»åŠ¨æ•è·é—®é¢˜
4. **çœŸå®ç”¨æˆ·ç›‘æ§ï¼ˆRUMï¼‰**ï¼šè·Ÿè¸ªå®é™…ç”¨æˆ·ä½“éªŒå’Œå‰ç«¯é”™è¯¯
5. **æ—¥å¿—æ¨¡å¼åˆ†æ**ï¼šä½¿ç”¨ SIEM å·¥å…·è¯†åˆ«é”™è¯¯å³°å€¼å’Œå¼‚å¸¸æ¨¡å¼
6. **APM é˜ˆå€¼**ï¼šåœ¨é”™è¯¯ç‡å¢åŠ ã€å»¶è¿Ÿå³°å€¼æˆ–ååé‡ä¸‹é™æ—¶å‘å‡ºè­¦æŠ¥

### é”™è¯¯èšåˆå’Œæ¨¡å¼è¯†åˆ«

å¯¹ç›¸å…³é”™è¯¯è¿›è¡Œåˆ†ç»„ä»¥è¯†åˆ«ç³»ç»Ÿæ€§é—®é¢˜ï¼š

- **æŒ‡çº¹è¯†åˆ«**ï¼šæŒ‰å †æ ˆè·Ÿè¸ªç›¸ä¼¼æ€§ã€é”™è¯¯ç±»å‹å’Œå—å½±å“çš„ä»£ç è·¯å¾„å¯¹é”™è¯¯è¿›è¡Œåˆ†ç»„
- **è¶‹åŠ¿åˆ†æ**ï¼šè·Ÿè¸ªä¸€æ®µæ—¶é—´å†…çš„é”™è¯¯é¢‘ç‡ä»¥æ£€æµ‹å›å½’æˆ–æ–°å‡ºç°çš„é—®é¢˜
- **å…³è”åˆ†æ**ï¼šå°†é”™è¯¯ä¸éƒ¨ç½²ã€é…ç½®æ›´æ”¹æˆ–å¤–éƒ¨äº‹ä»¶è”ç³»èµ·æ¥
- **ç”¨æˆ·å½±å“è¯„åˆ†**ï¼šæ ¹æ®å—å½±å“çš„ç”¨æˆ·å’Œä¼šè¯æ•°é‡ç¡®å®šä¼˜å…ˆçº§
- **åœ°ç†/æ—¶é—´æ¨¡å¼**ï¼šè¯†åˆ«ç‰¹å®šåŒºåŸŸæˆ–åŸºäºæ—¶é—´çš„é”™è¯¯é›†ç¾¤

## æ ¹æœ¬åŸå› åˆ†ææŠ€æœ¯

### ç³»ç»ŸåŒ–è°ƒæŸ¥è¿‡ç¨‹

å¯¹æ¯ä¸ªé”™è¯¯éµå¾ªæ­¤ç»“æ„åŒ–æ–¹æ³•ï¼š

1. **å¤ç°é”™è¯¯**ï¼šåˆ›å»ºæœ€å°çš„å¤ç°æ­¥éª¤ã€‚å¦‚æœæ˜¯é—´æ­‡æ€§çš„ï¼Œç¡®å®šè§¦å‘æ¡ä»¶
2. **éš”ç¦»æ•…éšœç‚¹**ï¼šå°†æ•…éšœå‘èµ·çš„ç¡®åˆ‡ä»£ç è¡Œæˆ–ç»„ä»¶èŒƒå›´ç¼©å°
3. **åˆ†æè°ƒç”¨é“¾**ï¼šä»é”™è¯¯å‘åè¿½æº¯ä»¥äº†è§£ç³»ç»Ÿå¦‚ä½•è¾¾åˆ°å¤±è´¥çŠ¶æ€
4. **æ£€æŸ¥å˜é‡çŠ¶æ€**ï¼šæ£€æŸ¥å¤±è´¥ç‚¹å’Œå‰å‡ æ­¥çš„å€¼
5. **å®¡æŸ¥æœ€è¿‘çš„æ›´æ”¹**ï¼šæ£€æŸ¥å—å½±å“ä»£ç è·¯å¾„çš„ git å†å²è®°å½•
6. **æµ‹è¯•å‡è®¾**ï¼šå½¢æˆå…³äºåŸå› çš„ç†è®ºå¹¶é€šè¿‡é’ˆå¯¹æ€§å®éªŒè¿›è¡ŒéªŒè¯

### äº”ä¸ªä¸ºä»€ä¹ˆæŠ€æœ¯

é‡å¤é—®"ä¸ºä»€ä¹ˆ"ä»¥æ·±å…¥æŒ–æ˜æ ¹æœ¬åŸå› ï¼š

```
é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥åœ¨ 30 ç§’åè¶…æ—¶

ä¸ºä»€ä¹ˆï¼Ÿæ•°æ®åº“è¿æ¥æ± å·²è€—å°½
ä¸ºä»€ä¹ˆï¼Ÿæ‰€æœ‰è¿æ¥éƒ½è¢«é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢å ç”¨
ä¸ºä»€ä¹ˆï¼Ÿæ–°åŠŸèƒ½å¼•å…¥äº† N+1 æŸ¥è¯¢æ¨¡å¼
ä¸ºä»€ä¹ˆï¼ŸORM å»¶è¿ŸåŠ è½½æœªæ­£ç¡®é…ç½®
ä¸ºä»€ä¹ˆï¼Ÿä»£ç å®¡æŸ¥æœªå‘ç°æ€§èƒ½å›å½’
```

æ ¹æœ¬åŸå› ï¼šæ•°æ®åº“æŸ¥è¯¢æ¨¡å¼çš„ä»£ç å®¡æŸ¥æµç¨‹ä¸è¶³ã€‚

### åˆ†å¸ƒå¼ç³»ç»Ÿè°ƒè¯•

å¯¹äºå¾®æœåŠ¡å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é”™è¯¯ï¼š

- **è·Ÿè¸ªè¯·æ±‚è·¯å¾„**ï¼šä½¿ç”¨å…³è” ID è·Ÿéšè·¨æœåŠ¡è¾¹ç•Œçš„è¯·æ±‚
- **æ£€æŸ¥æœåŠ¡ä¾èµ–**ï¼šè¯†åˆ«æ¶‰åŠå“ªäº›ä¸Šæ¸¸/ä¸‹æ¸¸æœåŠ¡
- **åˆ†æçº§è”æ•…éšœ**ï¼šç¡®å®šè¿™æ˜¯å¦æ˜¯å¦ä¸€ä¸ªæœåŠ¡æ•…éšœçš„ç—‡çŠ¶
- **å®¡æŸ¥æ–­è·¯å™¨çŠ¶æ€**ï¼šæ£€æŸ¥æ˜¯å¦è§¦å‘äº†ä¿æŠ¤æœºåˆ¶
- **æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¯»æ‰¾èƒŒå‹ã€æ­»ä¿¡æˆ–å¤„ç†å»¶è¿Ÿ
- **æ—¶é—´çº¿é‡å»º**ï¼šä½¿ç”¨åˆ†å¸ƒå¼è·Ÿè¸ªæ„å»ºè·¨æ‰€æœ‰æœåŠ¡çš„äº‹ä»¶æ—¶é—´çº¿

## å †æ ˆè·Ÿè¸ªåˆ†æ

### è§£é‡Šå †æ ˆè·Ÿè¸ª

ä»å †æ ˆè·Ÿè¸ªä¸­æå–æœ€å¤§ä¿¡æ¯ï¼š

**å…³é”®å…ƒç´ ï¼š**

- **é”™è¯¯ç±»å‹**ï¼šå‘ç”Ÿäº†ä»€ä¹ˆç±»å‹çš„å¼‚å¸¸/é”™è¯¯
- **é”™è¯¯æ¶ˆæ¯**ï¼šæœ‰å…³å¤±è´¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **èµ·æºç‚¹**ï¼šæŠ›å‡ºé”™è¯¯çš„æœ€æ·±å¸§
- **è°ƒç”¨é“¾**ï¼šå¯¼è‡´é”™è¯¯çš„å‡½æ•°è°ƒç”¨åºåˆ—
- **æ¡†æ¶ä¸åº”ç”¨ç¨‹åºä»£ç **ï¼šåŒºåˆ†åº“å’Œä½ çš„ä»£ç 
- **å¼‚æ­¥è¾¹ç•Œ**ï¼šè¯†åˆ«å¼‚æ­¥æ“ä½œä¸­æ–­è·Ÿè¸ªçš„ä½ç½®

**åˆ†æç­–ç•¥ï¼š**

1. ä»å †æ ˆé¡¶éƒ¨å¼€å§‹ï¼ˆé”™è¯¯èµ·æºï¼‰
2. è¯†åˆ«åº”ç”¨ç¨‹åºä»£ç ä¸­çš„ç¬¬ä¸€ä¸ªå¸§ï¼ˆä¸æ˜¯æ¡†æ¶/åº“ï¼‰
3. æ£€æŸ¥è¯¥å¸§çš„ä¸Šä¸‹æ–‡ï¼šè¾“å…¥å‚æ•°ã€å±€éƒ¨å˜é‡ã€çŠ¶æ€
4. é€šè¿‡è°ƒç”¨å‡½æ•°å‘åè¿½æº¯ä»¥äº†è§£å¦‚ä½•åˆ›å»ºäº†æ— æ•ˆçŠ¶æ€
5. å¯»æ‰¾æ¨¡å¼ï¼šè¿™æ˜¯åœ¨å¾ªç¯ä¸­å—ï¼Ÿåœ¨å›è°ƒå†…éƒ¨ï¼Ÿåœ¨å¼‚æ­¥æ“ä½œä¹‹åï¼Ÿ

### å †æ ˆè·Ÿè¸ªå¢å¼º

ç°ä»£é”™è¯¯è·Ÿè¸ªå·¥å…·æä¾›å¢å¼ºçš„å †æ ˆè·Ÿè¸ªï¼š

- **æºä»£ç ä¸Šä¸‹æ–‡**ï¼šæŸ¥çœ‹æ¯å¸§çš„å‘¨å›´ä»£ç è¡Œ
- **å±€éƒ¨å˜é‡å€¼**ï¼šæ£€æŸ¥æ¯å¸§çš„å˜é‡çŠ¶æ€ï¼ˆä½¿ç”¨ Sentry çš„è°ƒè¯•æ¨¡å¼ï¼‰
- **é¢åŒ…å±‘**ï¼šçœ‹åˆ°å¯¼è‡´é”™è¯¯çš„äº‹ä»¶åºåˆ—
- **å‘å¸ƒè·Ÿè¸ª**ï¼šå°†é”™è¯¯é“¾æ¥åˆ°ç‰¹å®šéƒ¨ç½²å’Œæäº¤
- **æºæ˜ å°„**ï¼šå¯¹äºç¼©å°çš„ JavaScriptï¼Œæ˜ å°„å›åŸå§‹æº
- **å†…è”æ³¨é‡Š**ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯æ³¨é‡Šå †æ ˆå¸§

### å¸¸è§å †æ ˆè·Ÿè¸ªæ¨¡å¼

**æ¨¡å¼ï¼šæ¡†æ¶ä»£ç æ·±å¤„çš„ç©ºæŒ‡é’ˆå¼‚å¸¸**

```
NullPointerException
  at java.util.HashMap.hash(HashMap.java:339)
  at java.util.HashMap.get(HashMap.java:556)
  at com.myapp.service.UserService.findUser(UserService.java:45)
```

æ ¹æœ¬åŸå› ï¼šåº”ç”¨ç¨‹åºå‘æ¡†æ¶ä»£ç ä¼ é€’äº† nullã€‚ä¸“æ³¨äº UserService.java:45ã€‚

**æ¨¡å¼ï¼šé•¿æ—¶é—´ç­‰å¾…åè¶…æ—¶**

```
TimeoutException: Operation timed out after 30000ms
  at okhttp3.internal.http2.Http2Stream.waitForIo
  at com.myapp.api.PaymentClient.processPayment(PaymentClient.java:89)
```

æ ¹æœ¬åŸå› ï¼šå¤–éƒ¨æœåŠ¡æ…¢/æ— å“åº”ã€‚éœ€è¦é‡è¯•é€»è¾‘å’Œæ–­è·¯å™¨ã€‚

**æ¨¡å¼ï¼šå¹¶å‘ä»£ç ä¸­çš„ç«æ€æ¡ä»¶**

```
ConcurrentModificationException
  at java.util.ArrayList$Itr.checkForComodification
  at com.myapp.processor.BatchProcessor.process(BatchProcessor.java:112)
```

æ ¹æœ¬åŸå› ï¼šåœ¨è¿­ä»£æ—¶ä¿®æ”¹äº†é›†åˆã€‚éœ€è¦çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„æˆ–åŒæ­¥ã€‚

## æ—¥å¿—èšåˆå’Œæ¨¡å¼åŒ¹é…

### ç»“æ„åŒ–æ—¥å¿—è®°å½•å®ç°

å®æ–½åŸºäº JSON çš„ç»“æ„åŒ–æ—¥å¿—è®°å½•ä»¥å®ç°æœºå™¨å¯è¯»çš„æ—¥å¿—ï¼š

**æ ‡å‡†æ—¥å¿—æ¶æ„ï¼š**

```json
{
  "timestamp": "2025-10-11T14:23:45.123Z",
  "level": "ERROR",
  "correlation_id": "req-7f3b2a1c-4d5e-6f7g-8h9i-0j1k2l3m4n5o",
  "trace_id": "4bf92f3577b34da6a3ce929d0e0e4736",
  "span_id": "00f067aa0ba902b7",
  "service": "payment-service",
  "environment": "production",
  "host": "pod-payment-7d4f8b9c-xk2l9",
  "version": "v2.3.1",
  "error": {
    "type": "PaymentProcessingException",
    "message": "Failed to charge card: Insufficient funds",
    "stack_trace": "...",
    "fingerprint": "payment-insufficient-funds"
  },
  "user": {
    "id": "user-12345",
    "ip": "203.0.113.42",
    "session_id": "sess-abc123"
  },
  "request": {
    "method": "POST",
    "path": "/api/v1/payments/charge",
    "duration_ms": 2547,
    "status_code": 402
  },
  "context": {
    "payment_method": "credit_card",
    "amount": 149.99,
    "currency": "USD",
    "merchant_id": "merchant-789"
  }
}
```

**å§‹ç»ˆåŒ…å«çš„å…³é”®å­—æ®µï¼š**

- `timestamp`ï¼šUTC ä¸­çš„ ISO 8601 æ ¼å¼
- `level`ï¼šERRORã€WARNã€INFOã€DEBUGã€TRACE
- `correlation_id`ï¼šæ•´ä¸ªè¯·æ±‚é“¾çš„å”¯ä¸€ ID
- `trace_id` å’Œ `span_id`ï¼šåˆ†å¸ƒå¼è·Ÿè¸ªçš„ OpenTelemetry æ ‡è¯†ç¬¦
- `service`ï¼šç”Ÿæˆæ­¤æ—¥å¿—çš„å¾®æœåŠ¡
- `environment`ï¼šdevã€stagingã€production
- `error.fingerprint`ï¼šç”¨äºå¯¹ç±»ä¼¼é”™è¯¯è¿›è¡Œåˆ†ç»„çš„ç¨³å®šæ ‡è¯†ç¬¦

### å…³è” ID æ¨¡å¼

å®æ–½å…³è” ID ä»¥è·Ÿè¸ªè·¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯·æ±‚ï¼š

**Node.js/Express ä¸­é—´ä»¶ï¼š**

```javascript
const { v4: uuidv4 } = require("uuid");
const asyncLocalStorage = require("async-local-storage");

// ç”Ÿæˆ/ä¼ æ’­å…³è” ID çš„ä¸­é—´ä»¶
function correlationIdMiddleware(req, res, next) {
  const correlationId = req.headers["x-correlation-id"] || uuidv4();
  req.correlationId = correlationId;
  res.setHeader("x-correlation-id", correlationId);

  // å­˜å‚¨åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­ä»¥åœ¨åµŒå¥—è°ƒç”¨ä¸­è®¿é—®
  asyncLocalStorage.run(new Map(), () => {
    asyncLocalStorage.set("correlationId", correlationId);
    next();
  });
}

// ä¼ æ’­åˆ°ä¸‹æ¸¸æœåŠ¡
function makeApiCall(url, data) {
  const correlationId = asyncLocalStorage.get("correlationId");
  return axios.post(url, data, {
    headers: {
      "x-correlation-id": correlationId,
      "x-source-service": "api-gateway",
    },
  });
}

// åœ¨æ‰€æœ‰æ—¥å¿—è¯­å¥ä¸­åŒ…å«
function log(level, message, context = {}) {
  const correlationId = asyncLocalStorage.get("correlationId");
  console.log(
    JSON.stringify({
      timestamp: new Date().toISOString(),
      level,
      correlation_id: correlationId,
      message,
      ...context,
    }),
  );
}
```

**Python/Flask å®ç°ï¼š**

```python
import uuid
import logging
from flask import request, g
import json

class CorrelationIdFilter(logging.Filter):
    def filter(self, record):
        record.correlation_id = g.get('correlation_id', 'N/A')
        return True

@app.before_request
def setup_correlation_id():
    correlation_id = request.headers.get('X-Correlation-ID', str(uuid.uuid4()))
    g.correlation_id = correlation_id

@app.after_request
def add_correlation_header(response):
    response.headers['X-Correlation-ID'] = g.correlation_id
    return response

# å¸¦å…³è” ID çš„ç»“æ„åŒ–æ—¥å¿—
logging.basicConfig(
    format='%(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)
logger.addFilter(CorrelationIdFilter())

def log_structured(level, message, **context):
    log_entry = {
        'timestamp': datetime.utcnow().isoformat() + 'Z',
        'level': level,
        'correlation_id': g.correlation_id,
        'service': 'payment-service',
        'message': message,
        **context
    }
    logger.log(getattr(logging, level), json.dumps(log_entry))
```

### æ—¥å¿—èšåˆæ¶æ„

**é›†ä¸­å¼æ—¥å¿—è®°å½•ç®¡é“ï¼š**

1. **åº”ç”¨ç¨‹åº**ï¼šè¾“å‡ºç»“æ„åŒ– JSON æ—¥å¿—åˆ° stdout/stderr
2. **æ—¥å¿—ä¼ é€å™¨**ï¼šFluentd/Fluent Bit/Vector ä»å®¹å™¨æ”¶é›†æ—¥å¿—
3. **æ—¥å¿—èšåˆå™¨**ï¼šElasticsearch/Loki/DataDog æ¥æ”¶å’Œç´¢å¼•æ—¥å¿—
4. **å¯è§†åŒ–**ï¼šKibana/Grafana/DataDog UI ç”¨äºæŸ¥è¯¢å’Œä»ªè¡¨æ¿
5. **è­¦æŠ¥**ï¼šå¯¹é”™è¯¯æ¨¡å¼å’Œé˜ˆå€¼è§¦å‘è­¦æŠ¥

**æ—¥å¿—æŸ¥è¯¢ç¤ºä¾‹ï¼ˆElasticsearch DSLï¼‰ï¼š**

```json
// æŸ¥æ‰¾ç‰¹å®šå…³è” ID çš„æ‰€æœ‰é”™è¯¯
{
  "query": {
    "bool": {
      "must": [
        { "match": { "correlation_id": "req-7f3b2a1c-4d5e-6f7g" }},
        { "term": { "level": "ERROR" }}
      ]
    }
  },
  "sort": [{ "timestamp": "asc" }]
}

// æŸ¥æ‰¾è¿‡å»ä¸€å°æ—¶å†…é”™è¯¯ç‡å³°å€¼
{
  "query": {
    "bool": {
      "must": [
        { "term": { "level": "ERROR" }},
        { "range": { "timestamp": { "gte": "now-1h" }}}
      ]
    }
  },
  "aggs": {
    "errors_per_minute": {
      "date_histogram": {
        "field": "timestamp",
        "fixed_interval": "1m"
      }
    }
  }
}

// æŒ‰æŒ‡çº¹åˆ†ç»„é”™è¯¯ä»¥æŸ¥æ‰¾æœ€å¸¸è§çš„é—®é¢˜
{
  "query": {
    "term": { "level": "ERROR" }
  },
  "aggs": {
    "error_types": {
      "terms": {
        "field": "error.fingerprint",
        "size": 10
      },
      "aggs": {
        "affected_users": {
          "cardinality": { "field": "user.id" }
        }
      }
    }
  }
}
```

### æ¨¡å¼æ£€æµ‹å’Œå¼‚å¸¸è¯†åˆ«

ä½¿ç”¨æ—¥å¿—åˆ†æè¯†åˆ«æ¨¡å¼ï¼š

- **é”™è¯¯ç‡å³°å€¼**ï¼šå°†å½“å‰é”™è¯¯ç‡ä¸å†å²åŸºçº¿è¿›è¡Œæ¯”è¾ƒï¼ˆä¾‹å¦‚ï¼Œ>3 ä¸ªæ ‡å‡†å·®ï¼‰
- **æ–°é”™è¯¯ç±»å‹**ï¼šä»¥å‰æœªå‡ºç°çš„é”™è¯¯æŒ‡çº¹å‡ºç°æ—¶å‘å‡ºè­¦æŠ¥
- **çº§è”æ•…éšœ**ï¼šæ£€æµ‹ä¸€ä¸ªæœåŠ¡ä¸­çš„é”™è¯¯ä½•æ—¶è§¦å‘ä¾èµ–æœåŠ¡ä¸­çš„é”™è¯¯
- **ç”¨æˆ·å½±å“æ¨¡å¼**ï¼šè¯†åˆ«å“ªäº›ç”¨æˆ·/ç¾¤ä½“å—åˆ°ä¸æˆæ¯”ä¾‹çš„å½±å“
- **åœ°ç†æ¨¡å¼**ï¼šå‘ç°ç‰¹å®šåŒºåŸŸçš„é—®é¢˜ï¼ˆä¾‹å¦‚ï¼ŒCDN é—®é¢˜ã€æ•°æ®ä¸­å¿ƒä¸­æ–­ï¼‰
- **æ—¶é—´æ¨¡å¼**ï¼šæŸ¥æ‰¾åŸºäºæ—¶é—´çš„é—®é¢˜ï¼ˆä¾‹å¦‚ï¼Œæ‰¹å¤„ç†ä½œä¸šã€è®¡åˆ’ä»»åŠ¡ã€æ—¶åŒºé”™è¯¯ï¼‰

## è°ƒè¯•å·¥ä½œæµ

### äº¤äº’å¼è°ƒè¯•

å¯¹äºå¼€å‘ä¸­çš„ç¡®å®šæ€§é”™è¯¯ï¼š

**è°ƒè¯•å™¨è®¾ç½®ï¼š**

1. åœ¨é”™è¯¯å‘ç”Ÿä¹‹å‰è®¾ç½®æ–­ç‚¹
2. é€è¡Œæ‰§è¡Œä»£ç æ‰§è¡Œ
3. æ£€æŸ¥å˜é‡å€¼å’Œå¯¹è±¡çŠ¶æ€
4. åœ¨è°ƒè¯•æ§åˆ¶å°ä¸­è¯„ä¼°è¡¨è¾¾å¼
5. è§‚å¯Ÿæ„å¤–çš„çŠ¶æ€å˜åŒ–
6. ä¿®æ”¹å˜é‡ä»¥æµ‹è¯•å‡è®¾

**ç°ä»£è°ƒè¯•å·¥å…·ï¼š**

- **VS Code è°ƒè¯•å™¨**ï¼šJavaScriptã€Pythonã€Goã€Javaã€C++ çš„é›†æˆè°ƒè¯•
- **Chrome DevTools**ï¼šå‰ç«¯è°ƒè¯•ï¼Œå…·æœ‰ç½‘ç»œã€æ€§èƒ½å’Œå†…å­˜åˆ†æåŠŸèƒ½
- **pdb/ipdb (Python)**ï¼šå…·æœ‰äº‹ååˆ†æåŠŸèƒ½çš„äº¤äº’å¼è°ƒè¯•å™¨
- **dlv (Go)**ï¼šGo ç¨‹åºçš„ Delve è°ƒè¯•å™¨
- **lldb (C/C++)**ï¼šå…·æœ‰åå‘è°ƒè¯•åŠŸèƒ½çš„ä½çº§è°ƒè¯•å™¨

### ç”Ÿäº§è°ƒè¯•

å¯¹äºè°ƒè¯•å™¨ä¸å¯ç”¨çš„ç”Ÿäº§ç¯å¢ƒä¸­çš„é”™è¯¯ï¼š

**å®‰å…¨çš„ç”Ÿäº§è°ƒè¯•æŠ€æœ¯ï¼š**

1. **å¢å¼ºæ—¥å¿—è®°å½•**ï¼šåœ¨å¯ç–‘æ•…éšœç‚¹å‘¨å›´æ·»åŠ æˆ˜ç•¥æ€§æ—¥å¿—è¯­å¥
2. **åŠŸèƒ½æ ‡å¿—**ï¼šä¸ºç‰¹å®šç”¨æˆ·/è¯·æ±‚å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
3. **é‡‡æ ·**ï¼šè®°å½•ä¸€å®šç™¾åˆ†æ¯”çš„è¯·æ±‚çš„è¯¦ç»†ä¸Šä¸‹æ–‡
4. **APM äº‹åŠ¡è·Ÿè¸ª**ï¼šä½¿ç”¨ DataDog APM æˆ– New Relic æŸ¥çœ‹è¯¦ç»†çš„äº‹åŠ¡æµ
5. **åˆ†å¸ƒå¼è·Ÿè¸ª**ï¼šåˆ©ç”¨ OpenTelemetry è·Ÿè¸ªäº†è§£è·¨æœåŠ¡äº¤äº’
6. **æ€§èƒ½åˆ†æ**ï¼šä½¿ç”¨è¿ç»­æ€§èƒ½åˆ†æå™¨ï¼ˆDataDog Profilerã€Pyroscopeï¼‰è¯†åˆ«çƒ­ç‚¹
7. **å †è½¬å‚¨**ï¼šæ•è·å†…å­˜å¿«ç…§ä»¥åˆ†æå†…å­˜æ³„æ¼
8. **æµé‡é•œåƒ**ï¼šåœ¨æš‚å­˜ä¸­é‡æ”¾ç”Ÿäº§æµé‡ä»¥è¿›è¡Œå®‰å…¨è°ƒæŸ¥

**è¿œç¨‹è°ƒè¯•ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ï¼š**

- ä»…åœ¨éå…³é”®æœåŠ¡ä¸­å°†è°ƒè¯•å™¨é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹
- ä½¿ç”¨ä¸æš‚åœæ‰§è¡Œçš„åªè¯»æ–­ç‚¹
- ä¸¥æ ¼é™åˆ¶è°ƒè¯•ä¼šè¯çš„æ—¶é—´
- å§‹ç»ˆå‡†å¤‡å¥½å›æ»šè®¡åˆ’

### å†…å­˜å’Œæ€§èƒ½è°ƒè¯•

**å†…å­˜æ³„æ¼æ£€æµ‹ï¼š**

```javascript
// Node.js å †å¿«ç…§æ¯”è¾ƒ
const v8 = require("v8");
const fs = require("fs");

function takeHeapSnapshot(filename) {
  const snapshot = v8.writeHeapSnapshot(filename);
  console.log(`Heap snapshot written to ${snapshot}`);
}

// æŒ‰é—´éš”æ‹æ‘„å¿«ç…§
takeHeapSnapshot("heap-before.heapsnapshot");
// ... è¿è¡Œå¯èƒ½æ³„æ¼çš„æ“ä½œ ...
takeHeapSnapshot("heap-after.heapsnapshot");

// åœ¨ Chrome DevTools å†…å­˜åˆ†æå™¨ä¸­åˆ†æ
// å¯»æ‰¾ä¿ç•™å¤§å°ä¸æ–­å¢åŠ çš„å¯¹è±¡
```

**æ€§èƒ½åˆ†æï¼š**

```python
# ä½¿ç”¨ cProfile è¿›è¡Œ Python æ€§èƒ½åˆ†æ
import cProfile
import pstats
from pstats import SortKey

def profile_function():
    profiler = cProfile.Profile()
    profiler.enable()

    # ä½ çš„ä»£ç åœ¨è¿™é‡Œ
    process_large_dataset()

    profiler.disable()

    stats = pstats.Stats(profiler)
    stats.sort_stats(SortKey.CUMULATIVE)
    stats.print_stats(20)  # å‰ 20 ä¸ªè€—æ—¶çš„å‡½æ•°
```

## é”™è¯¯é¢„é˜²ç­–ç•¥

### è¾“å…¥éªŒè¯å’Œç±»å‹å®‰å…¨

**é˜²å¾¡æ€§ç¼–ç¨‹ï¼š**

```typescript
// TypeScriptï¼šåˆ©ç”¨ç±»å‹ç³»ç»Ÿè¿›è¡Œç¼–è¯‘æ—¶å®‰å…¨
interface PaymentRequest {
  amount: number;
  currency: string;
  customerId: string;
  paymentMethodId: string;
}

function processPayment(request: PaymentRequest): PaymentResult {
  // å¤–éƒ¨è¾“å…¥çš„è¿è¡Œæ—¶éªŒè¯
  if (request.amount <= 0) {
    throw new ValidationError("é‡‘é¢å¿…é¡»ä¸ºæ­£æ•°");
  }

  if (!["USD", "EUR", "GBP"].includes(request.currency)) {
    throw new ValidationError("ä¸æ”¯æŒçš„è´§å¸");
  }

  // ä½¿ç”¨ Zod æˆ– Yup è¿›è¡Œå¤æ‚éªŒè¯
  const schema = z.object({
    amount: z.number().positive().max(1000000),
    currency: z.enum(["USD", "EUR", "GBP"]),
    customerId: z.string().uuid(),
    paymentMethodId: z.string().min(1),
  });

  const validated = schema.parse(request);

  // ç°åœ¨å¯ä»¥å®‰å…¨å¤„ç†
  return chargeCustomer(validated);
}
```

**Python ç±»å‹æç¤ºå’ŒéªŒè¯ï¼š**

```python
from typing import Optional
from pydantic import BaseModel, validator, Field
from decimal import Decimal

class PaymentRequest(BaseModel):
    amount: Decimal = Field(..., gt=0, le=1000000)
    currency: str
    customer_id: str
    payment_method_id: str

    @validator('currency')
    def validate_currency(cls, v):
        if v not in ['USD', 'EUR', 'GBP']:
            raise ValueError('ä¸æ”¯æŒçš„è´§å¸')
        return v

    @validator('customer_id', 'payment_method_id')
    def validate_ids(cls, v):
        if not v or len(v) < 1:
            raise ValueError('ID ä¸èƒ½ä¸ºç©º')
        return v

def process_payment(request: PaymentRequest) -> PaymentResult:
    # Pydantic åœ¨å®ä¾‹åŒ–æ—¶è‡ªåŠ¨éªŒè¯
    # ç±»å‹æç¤ºæä¾› IDE æ”¯æŒå’Œé™æ€åˆ†æ
    return charge_customer(request)
```

### é”™è¯¯è¾¹ç•Œå’Œä¼˜é›…é™çº§

**React é”™è¯¯è¾¹ç•Œï¼š**

```typescript
import React, { Component, ErrorInfo, ReactNode } from 'react';
import * as Sentry from '@sentry/react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false
  };

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    // è®°å½•åˆ°é”™è¯¯è·Ÿè¸ªæœåŠ¡
    Sentry.captureException(error, {
      contexts: {
        react: {
          componentStack: errorInfo.componentStack
        }
      }
    });

    console.error('æœªæ•è·çš„é”™è¯¯:', error, errorInfo);
  }

  public render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div role="alert">
          <h2>å‡ºç°äº†é—®é¢˜</h2>
          <details>
            <summary>é”™è¯¯è¯¦æƒ…</summary>
            <pre>{this.state.error?.message}</pre>
          </details>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
```

**æ–­è·¯å™¨æ¨¡å¼ï¼š**

```python
from datetime import datetime, timedelta
from enum import Enum
import time

class CircuitState(Enum):
    CLOSED = "closed"      # æ­£å¸¸æ“ä½œ
    OPEN = "open"          # å¤±è´¥ï¼Œæ‹’ç»è¯·æ±‚
    HALF_OPEN = "half_open"  # æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤

class CircuitBreaker:
    def __init__(self, failure_threshold=5, timeout=60, success_threshold=2):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.success_threshold = success_threshold
        self.failure_count = 0
        self.success_count = 0
        self.last_failure_time = None
        self.state = CircuitState.CLOSED

    def call(self, func, *args, **kwargs):
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
            else:
                raise CircuitBreakerOpenError("æ–­è·¯å™¨å·²æ‰“å¼€")

        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise

    def _on_success(self):
        self.failure_count = 0
        if self.state == CircuitState.HALF_OPEN:
            self.success_count += 1
            if self.success_count >= self.success_threshold:
                self.state = CircuitState.CLOSED
                self.success_count = 0

    def _on_failure(self):
        self.failure_count += 1
        self.last_failure_time = datetime.now()
        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN

    def _should_attempt_reset(self):
        return (datetime.now() - self.last_failure_time) > timedelta(seconds=self.timeout)

# ç”¨æ³•
payment_circuit = CircuitBreaker(failure_threshold=5, timeout=60)

def process_payment_with_circuit_breaker(payment_data):
    try:
        result = payment_circuit.call(external_payment_api.charge, payment_data)
        return result
    except CircuitBreakerOpenError:
        # ä¼˜é›…é™çº§ï¼šæ’é˜Ÿä»¥ä¾›ç¨åå¤„ç†
        payment_queue.enqueue(payment_data)
        return {"status": "queued", "message": "ä»˜æ¬¾å°†å¾ˆå¿«å¤„ç†"}
```

### å…·æœ‰æŒ‡æ•°é€€é¿çš„é‡è¯•é€»è¾‘

```typescript
// TypeScript é‡è¯•å®ç°
interface RetryOptions {
  maxAttempts: number;
  baseDelayMs: number;
  maxDelayMs: number;
  exponentialBase: number;
  retryableErrors?: string[];
}

async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  options: RetryOptions = {
    maxAttempts: 3,
    baseDelayMs: 1000,
    maxDelayMs: 30000,
    exponentialBase: 2,
  },
): Promise<T> {
  let lastError: Error;

  for (let attempt = 0; attempt < options.maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;

      // æ£€æŸ¥é”™è¯¯æ˜¯å¦å¯é‡è¯•
      if (
        options.retryableErrors &&
        !options.retryableErrors.includes(error.name)
      ) {
        throw error; // ä¸è¦é‡è¯•ä¸å¯é‡è¯•çš„é”™è¯¯
      }

      if (attempt < options.maxAttempts - 1) {
        const delay = Math.min(
          options.baseDelayMs * Math.pow(options.exponentialBase, attempt),
          options.maxDelayMs,
        );

        // æ·»åŠ æŠ–åŠ¨ä»¥é˜²æ­¢æƒŠç¾¤æ•ˆåº”
        const jitter = Math.random() * 0.1 * delay;
        const actualDelay = delay + jitter;

        console.log(
          `å°è¯• ${attempt + 1} å¤±è´¥ï¼Œ${actualDelay}ms åé‡è¯•`,
        );
        await new Promise((resolve) => setTimeout(resolve, actualDelay));
      }
    }
  }

  throw lastError!;
}

// ç”¨æ³•
const result = await retryWithBackoff(
  () => fetch("https://api.example.com/data"),
  {
    maxAttempts: 3,
    baseDelayMs: 1000,
    maxDelayMs: 10000,
    exponentialBase: 2,
    retryableErrors: ["NetworkError", "TimeoutError"],
  },
);
```

## ç›‘æ§å’Œè­¦æŠ¥é›†æˆ

### ç°ä»£å¯è§‚æµ‹æ€§æ ˆï¼ˆ2025ï¼‰

**æ¨èæ¶æ„ï¼š**

- **æŒ‡æ ‡**ï¼šPrometheus + Grafana æˆ– DataDog
- **æ—¥å¿—**ï¼šElasticsearch/Loki + Fluentd æˆ– DataDog Logs
- **è·Ÿè¸ª**ï¼šOpenTelemetry + Jaeger/Tempo æˆ– DataDog APM
- **é”™è¯¯**ï¼šSentry æˆ– DataDog Error Tracking
- **å‰ç«¯**ï¼šSentry Browser SDK æˆ– DataDog RUM
- **ç»¼åˆ**ï¼šDataDog Synthetics æˆ– Checkly

### Sentry é›†æˆ

**Node.js/Express è®¾ç½®ï¼š**

```javascript
const Sentry = require("@sentry/node");
const { ProfilingIntegration } = require("@sentry/profiling-node");

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  release: process.env.GIT_COMMIT_SHA,

  // æ€§èƒ½ç›‘æ§
  tracesSampleRate: 0.1, // 10% çš„äº‹åŠ¡
  profilesSampleRate: 0.1,

  integrations: [
    new ProfilingIntegration(),
    new Sentry.Integrations.Http({ tracing: true }),
    new Sentry.Integrations.Express({ app }),
  ],

  beforeSend(event, hint) {
    // æ¸…ç†æ•æ„Ÿæ•°æ®
    if (event.request) {
      delete event.request.cookies;
      delete event.request.headers?.authorization;
    }

    // æ·»åŠ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡
    event.tags = {
      ...event.tags,
      region: process.env.AWS_REGION,
      instance_id: process.env.INSTANCE_ID,
    };

    return event;
  },
});

// Express ä¸­é—´ä»¶
app.use(Sentry.Handlers.requestHandler());
app.use(Sentry.Handlers.tracingHandler());

// è·¯ç”±åœ¨è¿™é‡Œ...

// é”™è¯¯å¤„ç†ç¨‹åºï¼ˆå¿…é¡»æ˜¯æœ€åä¸€ä¸ªï¼‰
app.use(Sentry.Handlers.errorHandler());

// ä½¿ç”¨ä¸Šä¸‹æ–‡æ‰‹åŠ¨é”™è¯¯æ•è·
function processOrder(orderId) {
  try {
    const order = getOrder(orderId);
    chargeCustomer(order);
  } catch (error) {
    Sentry.captureException(error, {
      tags: {
        operation: "process_order",
        order_id: orderId,
      },
      contexts: {
        order: {
          id: orderId,
          status: order?.status,
          amount: order?.amount,
        },
      },
      user: {
        id: order?.customerId,
      },
    });
    throw error;
  }
}
```

### DataDog APM é›†æˆ

**Python/Flask è®¾ç½®ï¼š**

```python
from ddtrace import patch_all, tracer
from ddtrace.contrib.flask import TraceMiddleware
import logging

# è‡ªåŠ¨æ£€æµ‹å¸¸è§åº“
patch_all()

app = Flask(__name__)

# åˆå§‹åŒ–è·Ÿè¸ª
TraceMiddleware(app, tracer, service='payment-service')

# ç”¨äºè¯¦ç»†è·Ÿè¸ªçš„è‡ªå®šä¹‰ span
@app.route('/api/v1/payments/charge', methods=['POST'])
def charge_payment():
    with tracer.trace('payment.charge', service='payment-service') as span:
        payment_data = request.json

        # æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        span.set_tag('payment.amount', payment_data['amount'])
        span.set_tag('payment.currency', payment_data['currency'])
        span.set_tag('customer.id', payment_data['customer_id'])

        try:
            result = payment_processor.charge(payment_data)
            span.set_tag('payment.status', 'success')
            return jsonify(result), 200
        except InsufficientFundsError as e:
            span.set_tag('payment.status', 'insufficient_funds')
            span.set_tag('error', True)
            return jsonify({'error': 'ä½™é¢ä¸è¶³'}), 402
        except Exception as e:
            span.set_tag('payment.status', 'error')
            span.set_tag('error', True)
            span.set_tag('error.message', str(e))
            raise
```

### OpenTelemetry å®ç°

**å…·æœ‰ OpenTelemetry çš„ Go æœåŠ¡ï¼š**

```go
package main

import (
    "context"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/trace"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/codes"
)

func initTracer() (*sdktrace.TracerProvider, error) {
    exporter, err := otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("otel-collector:4317"),
        otlptracegrpc.WithInsecure(),
    )
    if err != nil {
        return nil, err
    }

    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("payment-service"),
            semconv.ServiceVersionKey.String("v2.3.1"),
            attribute.String("environment", "production"),
        )),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}

func processPayment(ctx context.Context, paymentReq PaymentRequest) error {
    tracer := otel.Tracer("payment-service")
    ctx, span := tracer.Start(ctx, "processPayment")
    defer span.End()

    // æ·»åŠ å±æ€§
    span.SetAttributes(
        attribute.Float64("payment.amount", paymentReq.Amount),
        attribute.String("payment.currency", paymentReq.Currency),
        attribute.String("customer.id", paymentReq.CustomerID),
    )

    // è°ƒç”¨ä¸‹æ¸¸æœåŠ¡
    err := chargeCard(ctx, paymentReq)
    if err != nil {
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
        return err
    }

    span.SetStatus(codes.Ok, "ä»˜æ¬¾å¤„ç†æˆåŠŸ")
    return nil
}

func chargeCard(ctx context.Context, paymentReq PaymentRequest) error {
    tracer := otel.Tracer("payment-service")
    ctx, span := tracer.Start(ctx, "chargeCard")
    defer span.End()

    // æ¨¡æ‹Ÿå¤–éƒ¨ API è°ƒç”¨
    result, err := paymentGateway.Charge(ctx, paymentReq)
    if err != nil {
        return fmt.Errorf("æ”¯ä»˜ç½‘å…³é”™è¯¯: %w", err)
    }

    span.SetAttributes(
        attribute.String("transaction.id", result.TransactionID),
        attribute.String("gateway.response_code", result.ResponseCode),
    )

    return nil
}
```

### è­¦æŠ¥é…ç½®

**æ™ºèƒ½è­¦æŠ¥ç­–ç•¥ï¼š**

```yaml
# DataDog ç›‘æ§é…ç½®
monitors:
  - name: "é«˜é”™è¯¯ç‡ - æ”¯ä»˜æœåŠ¡"
    type: metric
    query: "avg(last_5m):sum:trace.express.request.errors{service:payment-service} / sum:trace.express.request.hits{service:payment-service} > 0.05"
    message: |
      æ”¯ä»˜æœåŠ¡é”™è¯¯ç‡ä¸º {{value}}%ï¼ˆé˜ˆå€¼ï¼š5%ï¼‰

      è¿™å¯èƒ½è¡¨ç¤ºï¼š
      - æ”¯ä»˜ç½‘å…³é—®é¢˜
      - æ•°æ®åº“è¿æ¥é—®é¢˜
      - æ— æ•ˆçš„æ”¯ä»˜æ•°æ®

      Runbookï¼šhttps://wiki.company.com/runbooks/payment-errors

      @slack-payments-oncall @pagerduty-payments

    tags:
      - service:payment-service
      - severity:high

    options:
      notify_no_data: true
      no_data_timeframe: 10
      escalation_message: "10 åˆ†é’Ÿåé”™è¯¯ç‡ä»ç„¶å‡é«˜"

  - name: "æ£€æµ‹åˆ°æ–°é”™è¯¯ç±»å‹"
    type: log
    query: 'logs("level:ERROR service:payment-service").rollup("count").by("error.fingerprint").last("5m") > 0'
    message: |
      æ”¯ä»˜æœåŠ¡ä¸­æ£€æµ‹åˆ°æ–°é”™è¯¯ç±»å‹ï¼š{{error.fingerprint}}

      é¦–æ¬¡å‡ºç°ï¼š{{timestamp}}
      å—å½±å“ç”¨æˆ·ï¼š{{user_count}}

      @slack-engineering

    options:
      enable_logs_sample: true

  - name: "æ”¯ä»˜æœåŠ¡ - P95 å»¶è¿Ÿé«˜"
    type: metric
    query: "avg(last_10m):p95:trace.express.request.duration{service:payment-service} > 2000"
    message: |
      æ”¯ä»˜æœåŠ¡ P95 å»¶è¿Ÿä¸º {{value}}msï¼ˆé˜ˆå€¼ï¼š2000msï¼‰

      æ£€æŸ¥ï¼š
      - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
      - å¤–éƒ¨ API å“åº”æ—¶é—´
      - èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜ï¼‰

      ä»ªè¡¨æ¿ï¼šhttps://app.datadoghq.com/dashboard/payment-service

      @slack-payments-team
```

## ç”Ÿäº§äº‹ä»¶å“åº”

### äº‹ä»¶å“åº”å·¥ä½œæµ

**ç¬¬ 1 é˜¶æ®µï¼šæ£€æµ‹å’Œåˆ†ç±»ï¼ˆ0-5 åˆ†é’Ÿï¼‰**

1. ç¡®è®¤è­¦æŠ¥/äº‹ä»¶
2. æ£€æŸ¥äº‹ä»¶ä¸¥é‡æ€§å’Œç”¨æˆ·å½±å“
3. åˆ†é…äº‹ä»¶æŒ‡æŒ¥å®˜
4. åˆ›å»ºäº‹ä»¶é¢‘é“ï¼ˆ#incident-2025-10-11-payment-errorsï¼‰
5. å¦‚æœé¢å‘å®¢æˆ·ï¼Œæ›´æ–°çŠ¶æ€é¡µé¢

**ç¬¬ 2 é˜¶æ®µï¼šè°ƒæŸ¥ï¼ˆ5-30 åˆ†é’Ÿï¼‰**

1. æ”¶é›†å¯è§‚æµ‹æ€§æ•°æ®ï¼š
   - Sentry/DataDog ä¸­çš„é”™è¯¯ç‡
   - æ˜¾ç¤ºå¤±è´¥è¯·æ±‚çš„è·Ÿè¸ª
   - äº‹ä»¶å¼€å§‹æ—¶é—´å‘¨å›´çš„æ—¥å¿—
   - æ˜¾ç¤ºèµ„æºä½¿ç”¨ã€å»¶è¿Ÿã€ååé‡çš„æŒ‡æ ‡
2. ä¸æœ€è¿‘çš„æ›´æ”¹å…³è”ï¼š
   - æœ€è¿‘çš„éƒ¨ç½²ï¼ˆæ£€æŸ¥ CI/CD ç®¡é“ï¼‰
   - é…ç½®æ›´æ”¹
   - åŸºç¡€è®¾æ–½æ›´æ”¹
   - å¤–éƒ¨ä¾èµ–çŠ¶æ€
3. å½¢æˆå…³äºæ ¹æœ¬åŸå› çš„åˆæ­¥å‡è®¾
4. åœ¨äº‹ä»¶æ—¥å¿—ä¸­è®°å½•å‘ç°

**ç¬¬ 3 é˜¶æ®µï¼šç¼“è§£ï¼ˆç«‹å³ï¼‰**

1. æ ¹æ®å‡è®¾å®æ–½ç«‹å³ä¿®å¤ï¼š
   - å›æ»šæœ€è¿‘çš„éƒ¨ç½²
   - æ‰©å®¹èµ„æº
   - ç¦ç”¨æœ‰é—®é¢˜çš„åŠŸèƒ½ï¼ˆåŠŸèƒ½æ ‡å¿—ï¼‰
   - æ•…éšœè½¬ç§»åˆ°å¤‡ç”¨ç³»ç»Ÿ
   - åº”ç”¨çƒ­ä¿®å¤
2. éªŒè¯ç¼“è§£æœ‰æ•ˆï¼ˆé”™è¯¯ç‡ä¸‹é™ï¼‰
3. ç›‘æ§ 15-30 åˆ†é’Ÿä»¥ç¡®ä¿ç¨³å®š

**ç¬¬ 4 é˜¶æ®µï¼šæ¢å¤å’ŒéªŒè¯**

1. éªŒè¯æ‰€æœ‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸
2. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
3. å¤„ç†æ’é˜Ÿ/å¤±è´¥çš„è¯·æ±‚
4. æ›´æ–°çŠ¶æ€é¡µé¢ï¼šäº‹ä»¶å·²è§£å†³
5. é€šçŸ¥åˆ©ç›Šç›¸å…³è€…

**ç¬¬ 5 é˜¶æ®µï¼šäº‹åå®¡æŸ¥**

1. åœ¨ 48 å°æ—¶å†…å®‰æ’äº‹åä¼šè®®
2. åˆ›å»ºäº‹ä»¶çš„è¯¦ç»†æ—¶é—´çº¿
3. è¯†åˆ«æ ¹æœ¬åŸå› ï¼ˆå¯èƒ½ä¸åˆæ­¥å‡è®¾ä¸åŒï¼‰
4. è®°å½•ä¿ƒæˆå› ç´ 
5. ä¸ºä»¥ä¸‹å†…å®¹åˆ›å»ºæ“ä½œé¡¹ï¼š
   - é˜²æ­¢ç±»ä¼¼äº‹ä»¶
   - æ”¹å–„æ£€æµ‹æ—¶é—´
   - æ”¹å–„ç¼“è§£æ—¶é—´
   - æ”¹å–„æ²Ÿé€š

### äº‹ä»¶è°ƒæŸ¥å·¥å…·

**å¸¸è§äº‹ä»¶çš„æŸ¥è¯¢æ¨¡å¼ï¼š**

```
# æŸ¥æ‰¾ç‰¹å®šæ—¶é—´çª—å£çš„æ‰€æœ‰é”™è¯¯ï¼ˆElasticsearchï¼‰
GET /logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        { "term": { "level": "ERROR" }},
        { "term": { "service": "payment-service" }},
        { "range": { "timestamp": {
          "gte": "2025-10-11T14:00:00Z",
          "lte": "2025-10-11T14:30:00Z"
        }}}
      ]
    }
  },
  "sort": [{ "timestamp": "asc" }],
  "size": 1000
}

# æŸ¥æ‰¾é”™è¯¯å’Œéƒ¨ç½²ä¹‹é—´çš„å…³è”ï¼ˆDataDogï¼‰
# ä½¿ç”¨éƒ¨ç½²è·Ÿè¸ªåœ¨é”™è¯¯å›¾ä¸Šå åŠ éƒ¨ç½²æ ‡è®°
# æŸ¥è¯¢ï¼šsum:trace.express.request.errors{service:payment-service} by {version}

# è¯†åˆ«å—å½±å“çš„ç”¨æˆ·ï¼ˆSentryï¼‰
# å¯¼èˆªåˆ°é—®é¢˜ â†’ ç”¨æˆ·å½±å“é€‰é¡¹å¡
# æ˜¾ç¤ºï¼šå—å½±å“çš„æ€»ç”¨æˆ·ã€æ–°ç”¨æˆ·ä¸å›è®¿ç”¨æˆ·ã€åœ°ç†åˆ†å¸ƒ

# è·Ÿè¸ªç‰¹å®šçš„å¤±è´¥è¯·æ±‚ï¼ˆOpenTelemetry/Jaegerï¼‰
# æŒ‰ trace_id æˆ– correlation_id æœç´¢
# å¯è§†åŒ–è·¨æœåŠ¡çš„å®Œæ•´è¯·æ±‚è·¯å¾„
# è¯†åˆ«å“ªä¸ªæœåŠ¡/span å¤±è´¥
```

### æ²Ÿé€šæ¨¡æ¿

**åˆå§‹äº‹ä»¶é€šçŸ¥ï¼š**

```
ğŸš¨ äº‹ä»¶ï¼šä»˜æ¬¾å¤„ç†é”™è¯¯

ä¸¥é‡æ€§ï¼šé«˜
çŠ¶æ€ï¼šè°ƒæŸ¥ä¸­
å¼€å§‹æ—¶é—´ï¼š2025-10-11 14:23 UTC
äº‹ä»¶æŒ‡æŒ¥å®˜ï¼š@jane.smith

ç—‡çŠ¶ï¼š
- ä»˜æ¬¾å¤„ç†é”™è¯¯ç‡ï¼š15%ï¼ˆæ­£å¸¸ï¼š<1%ï¼‰
- å—å½±å“ç”¨æˆ·ï¼šè¿‡å» 10 åˆ†é’Ÿå†…çº¦ 500 äºº
- é”™è¯¯ï¼š"æ•°æ®åº“è¿æ¥è¶…æ—¶"

å·²é‡‡å–çš„è¡ŒåŠ¨ï¼š
- è°ƒæŸ¥æ•°æ®åº“è¿æ¥æ± 
- æ£€æŸ¥æœ€è¿‘çš„éƒ¨ç½²
- ç›‘æ§é”™è¯¯ç‡

æ›´æ–°ï¼šæ¯ 15 åˆ†é’Ÿæä¾›ä¸€æ¬¡æ›´æ–°
çŠ¶æ€é¡µé¢ï¼šhttps://status.company.com/incident/abc123
```

**ç¼“è§£é€šçŸ¥ï¼š**

```
âœ… äº‹ä»¶æ›´æ–°ï¼šå·²åº”ç”¨ç¼“è§£æªæ–½

ä¸¥é‡æ€§ï¼šé«˜ â†’ ä¸­
çŠ¶æ€ï¼šå·²ç¼“è§£
æŒç»­æ—¶é—´ï¼š27 åˆ†é’Ÿ

æ ¹æœ¬åŸå› ï¼šç”±äº 14:00 UTC çš„ v2.3.1 éƒ¨ç½²å¼•å…¥çš„é•¿æ—¶é—´è¿è¡ŒæŸ¥è¯¢
å¯¼è‡´æ•°æ®åº“è¿æ¥æ± è€—å°½

ç¼“è§£æªæ–½ï¼šå›æ»šåˆ° v2.3.0

å½“å‰çŠ¶æ€ï¼š
- é”™è¯¯ç‡ï¼š0.5%ï¼ˆæ¢å¤æ­£å¸¸ï¼‰
- æ‰€æœ‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸
- å¤„ç†æ’é˜Ÿä»˜æ¬¾çš„ç§¯å‹

ä¸‹ä¸€æ­¥ï¼š
- ç›‘æ§ 30 åˆ†é’Ÿ
- ä¿®å¤æŸ¥è¯¢æ€§èƒ½é—®é¢˜
- åœ¨æµ‹è¯•åéƒ¨ç½²ä¿®å¤ç‰ˆæœ¬
- å®‰æ’äº‹åä¼šè®®
```

## é”™è¯¯åˆ†æäº¤ä»˜ç‰©

å¯¹äºæ¯ä¸ªé”™è¯¯åˆ†æï¼Œæä¾›ï¼š

1. **é”™è¯¯æ‘˜è¦**ï¼šå‘ç”Ÿäº†ä»€ä¹ˆã€ä½•æ—¶ã€å½±å“èŒƒå›´
2. **æ ¹æœ¬åŸå› **ï¼šé”™è¯¯å‘ç”Ÿçš„æ ¹æœ¬åŸå› 
3. **è¯æ®**ï¼šæ”¯æŒè¯Šæ–­çš„å †æ ˆè·Ÿè¸ªã€æ—¥å¿—ã€æŒ‡æ ‡
4. **ç«‹å³ä¿®å¤**ï¼šè§£å†³é—®é¢˜çš„ä»£ç æ›´æ”¹
5. **æµ‹è¯•ç­–ç•¥**ï¼šå¦‚ä½•éªŒè¯ä¿®å¤æœ‰æ•ˆ
6. **é¢„é˜²æªæ–½**ï¼šå¦‚ä½•é˜²æ­¢å°†æ¥å‡ºç°ç±»ä¼¼é”™è¯¯
7. **ç›‘æ§å»ºè®®**ï¼šä»ç°åœ¨å¼€å§‹ç›‘æ§/è­¦æŠ¥ä»€ä¹ˆ
8. **Runbook**ï¼šå¤„ç†ç±»ä¼¼äº‹ä»¶çš„åˆ†æ­¥æŒ‡å—

ä¼˜å…ˆè€ƒè™‘å¯æ“ä½œçš„å»ºè®®ï¼Œä»¥æé«˜ç³»ç»Ÿå¯é æ€§å¹¶å‡å°‘æœªæ¥äº‹ä»¶çš„ MTTRï¼ˆå¹³å‡è§£å†³æ—¶é—´ï¼‰ã€‚

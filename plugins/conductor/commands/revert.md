---
description: "按逻辑工作单元（track、阶段或任务）进行感知 git 的撤销操作"
argument-hint: "[track-id | track-id:phase | track-id:task]"
---

# 撤销 Track

按逻辑工作单元撤销更改，具备完整的 git 感知能力。支持撤销整个 track、特定阶段或单个任务。

## 飞行前检查

1. 验证 Conductor 已初始化：
   - 检查 `conductor/tracks.md` 是否存在
   - 如果缺失：显示错误并建议先运行 `/conductor:setup`

2. 验证 git 仓库：
   - 运行 `git status` 确认 git 仓库
   - 检查是否有未提交的更改
   - 如果存在未提交的更改：

     ```
     警告：检测到未提交的更改

     有更改的文件：
     {文件列表}

     选项：
     1. 暂存更改并继续
     2. 先提交更改
     3. 取消撤销
     ```

3. 验证 git 状态足以进行撤销：
   - 没有正在进行的合并
   - 没有正在进行的变基
   - 如果发现问题：停止并解释解决步骤

## 目标选择

### 如果提供了参数：

解析参数格式：

**完整 track：** `{trackId}`

- 示例：`auth_20250115`
- 撤销整个 track 的所有提交

**特定阶段：** `{trackId}:phase{N}`

- 示例：`auth_20250115:phase2`
- 撤销阶段 N 及所有后续阶段的提交

**特定任务：** `{trackId}:task{X.Y}`

- 示例：`auth_20250115:task2.3`
- 仅撤销任务 X.Y 的提交

### 如果没有参数：

显示引导选择菜单：

```
您想要撤销什么？

正在进行中：
1. [~] dashboard_20250112 中的任务 2.3（最近）

最近完成：
2. [x] dashboard_20250112 中的任务 2.2（1 小时前）
3. [x] dashboard_20250112 中的阶段 1（3 小时前）
4. [x] 完整 track：auth_20250115（昨天）

选项：
5. 输入具体引用（track:phase 或 track:task）
6. 取消

选择选项：
```

## 提交发现

### 任务撤销

1. 搜索 git 日志中特定任务的提交：

   ```bash
   git log --oneline --grep="{trackId}" --grep="Task {X.Y}" --all-match
   ```

2. 同时查找 plan.md 更新提交：

   ```bash
   git log --oneline --grep="mark task {X.Y} complete" --grep="{trackId}" --all-match
   ```

3. 收集所有匹配的提交 SHA

### 阶段撤销

1. 通过读取 plan.md 确定阶段的任务范围
2. 搜索该阶段中的所有任务提交：

   ```bash
   git log --oneline --grep="{trackId}" | grep -E "Task {N}\.[0-9]"
   ```

3. 查找阶段验证提交（如果存在）
4. 查找阶段任务的所有 plan.md 更新提交
5. 按时间顺序收集所有匹配的提交 SHA

### 完整 Track 撤销

1. 查找提及该 track 的所有提交：

   ```bash
   git log --oneline --grep="{trackId}"
   ```

2. 查找 track 创建提交：

   ```bash
   git log --oneline -- "conductor/tracks/{trackId}/"
   ```

3. 按时间顺序收集所有匹配的提交 SHA

## 执行计划显示

在任何撤销操作之前，显示完整计划：

```
================================================================================
                           撤销执行计划
================================================================================

目标：{要撤销内容的描述}

要撤销的提交（按逆时间顺序）：
  1. abc1234 - feat: add chart rendering (dashboard_20250112)
  2. def5678 - chore: mark task 2.3 complete (dashboard_20250112)
  3. ghi9012 - feat: add data hooks (dashboard_20250112)
  4. jkl3456 - chore: mark task 2.2 complete (dashboard_20250112)

将受影响的文件：
  - src/components/Dashboard.tsx（已修改）
  - src/hooks/useData.ts（将被删除 - 在这些提交中创建）
  - conductor/tracks/dashboard_20250112/plan.md（已修改）

计划更新：
  - 任务 2.2：[x] -> [ ]
  - 任务 2.3：[~] -> [ ]

================================================================================
                              !! 警告 !!
================================================================================

此操作将：
- 创建 {N} 个撤销提交
- 修改 {M} 个文件
- 将 {P} 个任务重置为待处理状态

此操作无法轻易撤销，需要手动干预。

================================================================================

输入 'YES' 继续，或输入其他任何内容取消：
```

**关键：必须显式输入 'YES' 确认。不要在 'y'、'yes' 或回车时继续。**

## 撤销执行

按逆时间顺序执行撤销（从最新的开始）：

```
执行撤销计划...

[1/4] 撤销 abc1234...
      git revert --no-edit abc1234
      ✓ 成功

[2/4] 撤销 def5678...
      git revert --no-edit def5678
      ✓ 成功

[3/4] 撤销 ghi9012...
      git revert --no-edit ghi9012
      ✓ 成功

[4/4] 撤销 jkl3456...
      git revert --no-edit jkl3456
      ✓ 成功
```

### 发生合并冲突时

如果任何撤销产生合并冲突：

```
================================================================================
                           检测到合并冲突
================================================================================

撤销时发生冲突：{sha} - {message}

冲突文件：
  - src/components/Dashboard.tsx

选项：
1. 显示冲突详情
2. 中止撤销序列（保留已完成的撤销）
3. 打开手动解决指南

重要：已撤销 1-{N} 个提交。在继续之前或完全撤销撤销序列之前，
您可能需要手动解决此冲突。

选择选项：
```

**在任何冲突时立即停止。不要尝试自动解决。**

## Plan.md 更新

成功撤销 git 后，更新 plan.md：

1. 读取当前 plan.md
2. 对于每个已撤销的任务，更改标记：
   - `[x]` -> `[ ]`
   - `[~]` -> `[ ]`
3. 写入更新的 plan.md
4. 更新 metadata.json：
   - 减少 `tasks.completed`
   - 如需要则更新 `status`
   - 更新 `updated` 时间戳

**不要提交 plan.md 更改** - 它们是撤销操作的一部分

## Track 状态更新

### 如果撤销整个 track：

- 在 tracks.md 中：将 `[x]` 或 `[~]` 更改为 `[ ]`
- 考虑提供完全删除 track 目录的选项

### 如果撤销到未完成状态：

- 在 tracks.md 中：如果部分完成则标记为 `[~]`，如果完全撤销则标记为 `[ ]`

## 验证

撤销完成后：

```
================================================================================
                           撤销完成
================================================================================

摘要：
  - 已撤销 {N} 个提交
  - 将 {P} 个任务重置为待处理
  - {M} 个文件受影响

Git 日志现在显示：
  {最近的提交历史}

Plan.md 状态：
  - 任务 2.2：[ ] 待处理
  - 任务 2.3：[ ] 待处理

================================================================================

验证撤销是否成功：
  1. 运行测试：{测试命令}
  2. 检查应用程序：{相关检查}

如果发现问题，您可能需要：
  - 手动解决冲突
  - 重新实现已撤销的任务
  - 使用 'git revert HEAD~{N}..HEAD' 撤销这些撤销操作

================================================================================
```

## 安全规则

1. **永远不要使用 `git reset --hard`** - 只使用 `git revert`
2. **永远不要使用 `git push --force`** - 只使用安全的推送操作
3. **永远不要自动解决冲突** - 始终停止以等待人工干预
4. **始终显示完整计划** - 用户必须准确看到将要发生什么
5. **要求显式输入 'YES'** - 不是 'y'，不是回车，只有 'YES'
6. **在任何错误时停止** - 不要尝试在失败后继续
7. **保留历史** - 撤销提交优先于历史重写

## 边缘情况

### Track 从未提交

```
未找到 track 的提交：{trackId}

Track 存在但没有关联的提交。这可能意味着：
- 实施从未开始
- 提交使用了不同的格式

选项：
1. 仅删除 track 目录
2. 取消
```

### 提交已撤销

```
某些提交似乎已被撤销：
  - abc1234 已被 xyz9876 撤销

选项：
1. 跳过已撤销的提交
2. 取消并调查
```

### 已推送到远程

```
警告：某些提交已推送到远程

远程上的提交：
  - abc1234 (origin/main)
  - def5676 (origin/main)

撤销将创建新的撤销提交，您需要推送这些提交。
这是安全的方法（不需要强制推送）。

继续撤销？(YES/no)：
```

## 撤销撤销操作

如果用户需要撤销撤销操作本身：

```
要撤销此撤销操作：

  git revert HEAD~{N}..HEAD

这将创建恢复已撤销更改的新提交。

或者，如果尚未推送：
  git reset --soft HEAD~{N}
  git checkout -- .

（谨慎使用 - 这将丢弃撤销提交）
```

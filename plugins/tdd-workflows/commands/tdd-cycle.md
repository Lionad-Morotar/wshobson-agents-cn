执行严格的测试驱动开发（TDD）工作流程，遵循红绿重构的纪律：

[扩展思考：此工作流程通过协调的智能体编排强制执行测试优先开发。TDD 周期的每个阶段都严格实施失败优先验证、增量实现和持续重构。该工作流程支持单测试和测试套件两种方法，并可配置覆盖率阈值。]

## 配置

### 覆盖率阈值

- 最低行覆盖率：80%
- 最低分支覆盖率：75%
- 关键路径覆盖率：100%

### 重构触发条件

- 圈复杂度 > 10
- 方法长度 > 20 行
- 类长度 > 200 行
- 重复代码块 > 3 行

## 阶段 1：测试规格与设计

### 1. 需求分析

- 使用 Task 工具，设置 subagent_type="comprehensive-review::architect-review"
- 提示词："分析 $ARGUMENTS 的需求。定义验收标准，识别边界情况，并创建测试场景。输出全面的测试规格。"
- 输出：测试规格、验收标准、边界情况矩阵
- 验证：确保所有需求都有对应的测试场景

### 2. 测试架构设计

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："基于测试规格为 $ARGUMENTS 设计测试架构。定义测试结构、测试夹具、模拟对象和测试数据策略。确保可测试性和可维护性。"
- 输出：测试架构、夹具设计、模拟策略
- 验证：架构支持隔离、快速、可靠的测试

## 阶段 2：RED - 编写失败的测试

### 3. 编写单元测试（失败状态）

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："为 $ARGUMENTS 编写失败的单元测试。测试必须初始失败。包括边界情况、错误场景和正常路径。不要实现生产代码。"
- 输出：失败的单元测试、测试文档
- **关键**：验证所有测试都以预期的错误消息失败

### 4. 验证测试失败

- 使用 Task 工具，设置 subagent_type="tdd-workflows::code-reviewer"
- 提示词："验证 $ARGUMENTS 的所有测试都正确失败。确保失败的原因正确（缺少实现，而非测试错误）。确认没有误报。"
- 输出：测试失败验证报告
- **关卡**：在所有测试适当失败之前不得继续

## 阶段 3：GREEN - 使测试通过

### 5. 最小化实现

- 使用 Task 工具，设置 subagent_type="backend-development::backend-architect"
- 提示词："为 $ARGUMENTS 实现使测试通过的最低限度代码。仅专注于使测试变绿。不要添加额外功能或优化。保持简单。"
- 输出：最小化工作实现
- 约束：除了通过测试所需的代码外，不得添加其他代码

### 6. 验证测试成功

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："运行 $ARGUMENTS 的所有测试并验证它们通过。检查测试覆盖率指标。确保没有测试被意外破坏。"
- 输出：测试执行报告、覆盖率指标
- **关卡**：所有测试必须通过才能继续

## 阶段 4：REFACTOR - 改进代码质量

### 7. 代码重构

- 使用 Task 工具，设置 subagent_type="tdd-workflows::code-reviewer"
- 提示词："在保持测试通过的同时重构 $ARGUMENTS 的实现。应用 SOLID 原则，消除重复，改进命名，并优化性能。每次重构后运行测试。"
- 输出：重构后的代码、重构报告
- 约束：测试必须始终保持通过

### 8. 测试重构

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："重构 $ARGUMENTS 的测试。消除测试重复，改进测试名称，提取公共夹具，并增强测试可读性。确保测试仍然提供相同的覆盖率。"
- 输出：重构后的测试、改进的测试结构
- 验证：覆盖率指标不变或有所改善

## 阶段 5：集成测试与系统测试

### 9. 编写集成测试（首先失败）

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："为 $ARGUMENTS 编写失败的集成测试。测试组件交互、API 契约和数据流。测试必须初始失败。"
- 输出：失败的集成测试
- 验证：测试因缺少集成逻辑而失败

### 10. 实现集成

- 使用 Task 工具，设置 subagent_type="backend-development::backend-architect"
- 提示词："为 $ARGUMENTS 实现集成代码以使集成测试通过。专注于组件交互和数据流。"
- 输出：集成实现
- 验证：所有集成测试通过

## 阶段 6：持续改进循环

### 11. 性能与边界情况测试

- 使用 Task 工具，设置 subagent_type="unit-testing::test-automator"
- 提示词："为 $ARGUMENTS 添加性能测试和额外的边界情况测试。包括压力测试、边界测试和错误恢复测试。"
- 输出：扩展的测试套件
- 指标：增加的测试覆盖率和场景覆盖率

### 12. 最终代码审查

- 使用 Task 工具，设置 subagent_type="comprehensive-review::architect-review"
- 提示词："对 $ARGUMENTS 进行全面审查。验证是否遵循了 TDD 流程，检查代码质量、测试质量和覆盖率。提出改进建议。"
- 输出：审查报告、改进建议
- 行动：在保持测试通过的同时实施关键建议

## 增量开发模式

逐个测试的开发方式：

1. 编写一个失败的测试
2. 仅使该测试通过
3. 如有需要则重构
4. 对下一个测试重复此过程

通过添加 `--incremental` 标志使用此方法，一次专注于一个测试。

## 测试套件模式

全面的测试套件开发方式：

1. 为功能/模块编写所有测试（失败状态）
2. 实现代码使所有测试通过
3. 重构整个模块
4. 添加集成测试

通过添加 `--suite` 标志使用此方法进行批量测试开发。

## 验证检查点

### RED 阶段验证

- [ ] 在实现之前编写所有测试
- [ ] 所有测试都有意义的错误消息而失败
- [ ] 测试失败是由于缺少实现
- [ ] 没有测试意外通过

### GREEN 阶段验证

- [ ] 所有测试通过
- [ ] 没有超出测试要求的额外代码
- [ ] 覆盖率满足最低阈值
- [ ] 没有修改测试以使其通过

### REFACTOR 阶段验证

- [ ] 重构后所有测试仍然通过
- [ ] 代码复杂度降低
- [ ] 消除重复
- [ ] 性能改善或保持
- [ ] 测试可读性提高

## 覆盖率报告

在每个阶段后生成覆盖率报告：

- 行覆盖率
- 分支覆盖率
- 函数覆盖率
- 语句覆盖率

## 失败恢复

如果违反了 TDD 纪律：

1. 立即**停止**
2. 识别违反了哪个阶段
3. 回滚到最后一个有效状态
4. 从正确的阶段重新开始
5. 记录经验教训

## TDD 指标跟踪

跟踪并报告：

- 每个阶段的时间（红/绿/重构）
- 测试-实现循环次数
- 覆盖率进展
- 重构频率
- 缺陷逃逸率

## 需避免的反模式

- 在测试之前编写实现
- 编写已经通过的测试
- 跳过重构阶段
- 在没有测试的情况下编写多个功能
- 修改测试以使其通过
- 忽略失败的测试
- 在实现之后编写测试

## 成功标准

- 100% 的代码采用测试优先编写
- 所有测试持续通过
- 覆盖率超过阈值
- 代码复杂度在限制范围内
- 覆盖代码中的零缺陷
- 清晰的测试文档
- 快速的测试执行（单元测试 < 5 秒）

## 注意事项

- 强制执行严格的 RED-GREEN-REFACTOR 纪律
- 每个阶段必须完成后才能进入下一个
- 测试即规格
- 如果测试难以编写，说明设计需要改进
- 重构不是可选的
- 保持测试执行快速
- 测试应该独立且隔离

为 $ARGUMENTS 实现 TDD

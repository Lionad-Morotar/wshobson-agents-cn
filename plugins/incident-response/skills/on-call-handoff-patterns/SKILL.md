---
name: on-call-handoff-patterns
description: 掌握值班轮班交接，包括上下文传递、升级程序和文档记录。在转移值班责任、记录轮班摘要或改进值班流程时使用。
---

# 值班交接模式

值班轮班过渡的有效模式，确保跨班次的连续性、上下文传递和可靠的事件响应。

## 何时使用此技能

- 转移值班责任
- 编写轮班交接摘要
- 记录正在进行的调查
- 建立值班轮换程序
- 改进交接质量
- 新值班工程师入职培训

## 核心概念

### 1. 交接组件

| 组件 | 目的 |
| -------------------------- | ----------------------- |
| **活跃事件** | 当前有什么问题 |
| **正在进行的调查** | 正在调试的问题 |
| **最近的更改** | 部署、配置 |
| **已知问题** | 已采取的变通方法 |
| **即将到来的事件** | 维护、发布 |

### 2. 交接时机

```
推荐：班次之间 30 分钟重叠

交接班：
├── 15 分钟：编写交接文档
└── 15 分钟：与接班人同步通话

接班人：
├── 15 分钟：审查交接文档
├── 15 分钟：与交班人同步通话
└── 5 分钟：验证警报设置
```

## 模板

### 模板 1：轮班交接文档

````markdown
# 值班交接：平台团队

**交班人**：@alice（2024-01-15 至 2024-01-22）
**接班人**：@bob（2024-01-22 至 2024-01-29）
**交接时间**：2024-01-22 09:00 UTC

---

## 🔴 活跃事件

### 目前无活跃事件

交接时无活跃事件。

---

## 🟡 正在进行的调查

### 1. 间歇性 API 超时（ENG-1234）

**状态**：调查中
**开始时间**：2024-01-20
**影响**：约 0.1% 的请求超时

**上下文**：

- 超时与数据库备份窗口相关（02:00-03:00 UTC）
- 怀疑备份进程导致锁争用
- 在 PR #567 中添加了额外日志（于 01/21 部署）

**下一步**：

- [ ] 今晚备份后审查新日志
- [ ] 如确认，考虑移动备份窗口

**资源**：

- 仪表板：[API 延迟](https://grafana/d/api-latency)
- 线程：#platform-eng（01/20，14:32）

---

### 2. 认证服务内存增长（ENG-1235）

**状态**：监控中
**开始时间**：2024-01-18
**影响**：暂无（主动发现）

**上下文**：

- 内存使用每天增长约 5%
- 性能分析中未发现内存泄漏
- 怀疑连接池未正确释放

**下一步**：

- [ ] 审查来自 01/21 的堆转储
- [ ] 如果使用率 > 80%，考虑重启

**资源**：

- 仪表板：[认证服务内存](https://grafana/d/auth-memory)
- 分析文档：[内存调查](https://docs/eng-1235)

---

## 🟢 本班次已解决

### 支付服务中断（2024-01-19）

- **持续时间**：23 分钟
- **根本原因**：数据库连接耗尽
- **解决方案**：回滚 v2.3.4，增加池大小
- **事后分析**：[POSTMORTEM-89](https://docs/postmortem-89)
- **后续工单**：ENG-1230、ENG-1231

---

## 📋 最近的更改

### 部署

| 服务 | 版本 | 时间 | 备注 |
| ------------ | ------- | ----------- | -------------------------- |
| api-gateway | v3.2.1 | 01/21 14:00 | 标头解析错误修复 |
| user-service | v2.8.0 | 01/20 10:00 | 新的个人资料功能 |
| auth-service | v4.1.2 | 01/19 16:00 | 安全补丁 |

### 配置更改

- 01/21：将 API 速率限制从 1000 增加到 1500 RPS
- 01/20：将数据库连接池最大值从 50 更新到 75

### 基础设施

- 01/20：向 Kubernetes 集群添加 2 个节点
- 01/19：将 Redis 从 6.2 升级到 7.0

---

## ⚠️ 已知问题和变通方法

### 1. 仪表板加载缓慢

**问题**：Grafana 仪表板在周一早晨缓慢
**变通方法**：在 08:00 UTC 后等待 5 分钟，让缓存预热
**工单**：OPS-456（P3）

### 2. 不稳定的集成测试

**问题**：`test_payment_flow` 在 CI 中间歇性失败
**变通方法**：重新运行失败的作业（通常在重试时通过）
**工单**：ENG-1200（P2）

---

## 📅 即将到来的事件

| 日期 | 事件 | 影响 | 联系人 |
| ----------- | -------------------- | ------------------- | ------------- |
| 01/23 02:00 | 数据库维护 | 5 分钟只读 | @dba-team |
| 01/24 14:00 | 主要版本 v5.0 | 密切监控 | @release-team |
| 01/25 | 营销活动 | 预期流量 2 倍 | @platform |

---

## 📞 升级提醒

| 问题类型 | 首次升级 | 二次升级 |
| --------------- | -------------------- | ----------------- |
| 支付问题 | @payments-oncall | @payments-manager |
| 认证问题 | @auth-oncall | @security-team |
| 数据库问题 | @dba-team | @infra-manager |
| 未知/严重 | @engineering-manager | @vp-engineering |

---

## 🔧 快速参考

### 常用命令

```bash
# 检查服务健康状况
kubectl get pods -A | grep -v Running

# 最近的部署
kubectl get events --sort-by='.lastTimestamp' | tail -20

# 数据库连接
psql -c "SELECT count(*) FROM pg_stat_activity;"

# 清除缓存（仅紧急情况）
redis-cli FLUSHDB
````

### 重要链接

- [运行手册](https://wiki/runbooks)
- [服务目录](https://wiki/services)
- [事件 Slack](https://slack.com/incidents)
- [PagerDuty](https://pagerduty.com/schedules)

---

## 交接清单

### 交班工程师

- [x] 记录活跃事件
- [x] 记录正在进行的调查
- [x] 列出最近的更改
- [x] 注明已知问题
- [x] 添加即将到来的事件
- [x] 与接班工程师同步

### 接班工程师

- [ ] 阅读本文档
- [ ] 加入同步通话
- [ ] 验证 PagerDuty 路由到您
- [ ] 验证 Slack 通知正常工作
- [ ] 检查 VPN/访问权限
- [ ] 审查关键仪表板

````

### 模板 2：快速交接（异步）

```markdown
# 快速交接：@alice → @bob

## 简介
- 无活跃事件
- 1 项调查进行中（API 超时，见 ENG-1234）
- 明天（01/24）主要版本发布 - 准备好应对问题

## 关注列表
1. 02:00-03:00 UTC 左右的 API 延迟（备份窗口）
2. 认证服务内存（如果 > 80% 则重启）

## 最近情况
- 昨天部署了 api-gateway v3.2.1（稳定）
- 将速率限制增加到 1500 RPS

## 即将发生
- 01/23 02:00 - 数据库维护（5 分钟只读）
- 01/24 14:00 - v5.0 发布

## 有问题吗？
今天 17:00 之前我可以在 Slack 上联系。
````

### 模板 3：事件交接（事件进行中）

```markdown
# 事件交接：支付服务降级

**事件开始**：2024-01-22 08:15 UTC
**当前状态**：缓解中
**严重程度**：SEV2

---

## 当前状态

- 错误率：15%（从 40% 下降）
- 正在进行的缓解：扩容 Pod
- 预计解决时间：约 30 分钟

## 我们已知的

1. 根本原因：payment-service Pod 上的内存压力
2. 触发原因：异常流量激增（正常的 3 倍）
3. 促成因素：结账流程中的低效查询

## 我们已采取的操作

- 将 payment-service 从 5 个 Pod 扩容到 15 个
- 在结账端点上启用速率限制
- 禁用非关键功能

## 需要执行的操作

1. 监控错误率 - 应在约 15 分钟内达到 <1%
2. 如果未改善，升级到 @payments-manager
3. 稳定后，开始根因调查

## 关键人员

- 事件指挥：@alice（交接中）
- 沟通负责人：@charlie
- 技术负责人：@bob（接班人）

## 沟通

- 状态页面：于 08:45 更新
- 客户支持：已通知
- 管理团队：已知晓

## 资源

- 事件频道：#inc-20240122-payment
- 仪表板：[支付服务](https://grafana/d/payments)
- 运行手册：[支付降级](https://wiki/runbooks/payments)

---

**接班值班（@bob）- 请确认您已：**

- [ ] 加入 #inc-20240122-payment
- [ ] 访问仪表板
- [ ] 了解当前状态
- [ ] 知道升级路径
```

## 交接同步会议

### 议程（15 分钟）

```markdown
## 交接同步：@alice → @bob

1. **活跃问题**（5 分钟）
   - 查看任何正在进行的事件
   - 讨论调查状态
   - 传递上下文和理论

2. **最近的更改**（3 分钟）
   - 需要关注的部署
   - 配置更改
   - 已知的回归

3. **即将到来的事件**（3 分钟）
   - 维护窗口
   - 预期的流量变化
   - 计划的发布

4. **问题**（4 分钟）
   - 澄清任何不清楚的问题
   - 确认访问和警报
   - 交换联系信息
```

## 值班最佳实践

### 轮班前

```markdown
## 轮班前清单

### 访问验证

- [ ] VPN 正常工作
- [ ] 对所有集群的 kubectl 访问权限
- [ ] 数据库读取权限
- [ ] 日志聚合器访问权限（Splunk/DataDog）
- [ ] PagerDuty 应用程序已安装并登录

### 警报设置

- [ ] PagerDuty 日程表显示您为主要负责人
- [ ] 电话通知已启用
- [ ] 事件频道的 Slack 通知
- [ ] 收到并确认测试警报

### 知识更新

- [ ] 审查最近的事件（过去 2 周）
- [ ] 检查服务变更日志
- [ ] 浏览关键运行手册
- [ ] 了解升级联系人

### 环境准备

- [ ] 笔记本电脑已充电且可访问
- [ ] 电话已充电
- [ ] 有安静的空间进行通话
- [ ] 已确定备用联系人（如旅行中）
```

### 轮班期间

```markdown
## 每日值班例行工作

### 早晨（一天开始）

- [ ] 检查夜间警报
- [ ] 审查仪表板异常
- [ ] 检查是否有创建的 P0/P1 工单
- [ ] 浏览事件频道以获取上下文

### 全天

- [ ] 在 SLA 内响应警报
- [ ] 记录调查进度
- [ ] 向团队更新重大问题
- [ ] 对传入的页面进行分类

### 一天结束

- [ ] 交接任何活跃问题
- [ ] 更新调查文档
- [ ] 为下一班次记录任何事项
```

### 轮班后

```markdown
## 轮班后清单

- [ ] 完成交接文档
- [ ] 与接班值班同步
- [ ] 验证 PagerDuty 路由已更改
- [ ] 关闭/更新调查工单
- [ ] 为任何事件提交事后分析
- [ ] 如果轮班压力大，请休息
```

## 升级指南

### 何时升级

```markdown
## 升级触发条件

### 立即升级

- 宣布 SEV1 事件
- 疑似数据泄露
- 30 分钟内无法诊断
- 收到客户或法务升级

### 考虑升级

- 问题跨越多个团队
- 需要您不具备的专业知识
- 业务影响超过阈值
- 您不确定下一步该怎么做

### 如何升级

1. 寻呼相应的升级路径
2. 在 Slack 中提供简要上下文
3. 保持参与，直到升级确认
4. 干净地交接，不要直接消失
```

## 最佳实践

### 应该做的

- **记录一切** - 未来的你会感谢你
- **尽早升级** - 小心驶得万年船
- **休息一下** - 警报疲劳是真实存在的
- **保持交接同步** - 异步会丢失上下文
- **测试您的设置** - 在事件之前，而不是期间

### 不应该做的

- **不要跳过交接** - 上下文丢失会导致事件
- **不要逞英雄** - 需要时升级
- **不要忽视警报** - 即使它们看起来很轻微
- **不要带病工作** - 改为交换班次
- **不要消失** - 轮班期间保持可联系

## 资源

- [Google SRE - 值班](https://sre.google/sre-book/being-on-call/)
- [PagerDuty 值班指南](https://www.pagerduty.com/resources/learn/on-call-management/)
- [Increment 值班期刊](https://increment.com/on-call/)

---
name: postmortem-writing
description: 撰写有效的无责备事后分析，包含根因分析、时间线和行动项。在进行事件审查、编写事后分析文档或改进事件响应流程时使用。
---

# 事后分析写作

撰写有效的无责备事后分析的综合指南，推动组织学习并防止事件复发。

## 何时使用此技能

- 进行事件后审查
- 编写事后分析文档
- 促进无责备事后分析会议
- 识别根本原因和促成因素
- 创建可执行的后续项目
- 建设组织学习文化

## 核心概念

### 1. 无责备文化

| 责备导向 | 无责备 |
| ------------------------ | --------------------------------- |
| "谁造成的？" | "什么条件允许了这种情况？" |
| "某人犯了错误" | "系统允许了这个错误" |
| 惩罚个人 | 改进系统 |
| 隐藏信息 | 分享学习 |
| 害怕发声 | 心理安全 |

### 2. 事后分析触发条件

- SEV1 或 SEV2 事件
- 面向客户的中断超过 15 分钟
- 数据丢失或安全事件
- 本可能严重的险肇事件
- 新的故障模式
- 需要非常规干预的事件

## 快速开始

### 事后分析时间线

```
第 0 天：事件发生
第 1-2 天：起草事后分析文档
第 3-5 天：事后分析会议
第 5-7 天：定稿文档，创建工单
第 2 周以上：行动项完成
每季度：审查跨事件模式
```

## 模板

### 模板 1：标准事后分析

```markdown
# 事后分析：[事件标题]

**日期**：2024-01-15
**作者**：@alice、@bob
**状态**：草稿 | 审查中 | 最终版
**事件严重程度**：SEV2
**事件持续时间**：47 分钟

## 执行摘要

2024 年 1 月 15 日，支付处理服务经历了 47 分钟的中断，影响约 12,000 名客户。根本原因是部署 v2.3.4 中的配置更改触发了数据库连接池耗尽。通过回滚到 v2.3.3 并增加连接池限制，事件得到解决。

**影响**：

- 12,000 名客户无法完成购买
- 预计收入损失：$45,000
- 创建了 847 个支持工单
- 无数据丢失或安全影响

## 时间线（所有时间为 UTC）

| 时间 | 事件 |
| ----- | ----------------------------------------------- |
| 14:23 | 部署 v2.3.4 完成到生产环境 |
| 14:31 | 首次警报：`payment_error_rate > 5%` |
| 14:33 | 值班工程师 @alice 确认警报 |
| 14:35 | 开始初步调查，错误率达到 23% |
| 14:41 | 宣布事件为 SEV2，@bob 加入 |
| 14:45 | 识别出数据库连接耗尽 |
| 14:52 | 决定回滚部署 |
| 14:58 | 启动回滚到 v2.3.3 |
| 15:10 | 回滚完成，错误率下降 |
| 15:18 | 服务完全恢复，事件已解决 |

## 根因分析

### 发生了什么

v2.3.4 部署包含了对数据库查询模式的更改，无意中为一个频繁调用的端点删除了连接池。每个请求打开一个新的数据库连接，而不是重用池化的连接。

### 为什么发生

1. **直接原因**：`PaymentRepository.java` 中的代码更改用直接的 `DriverManager.getConnection()` 调用替换了池化的 `DataSource`。

2. **促成因素**：
   - 代码审查未发现连接处理更改
   - 没有专门针对连接池行为的集成测试
   - Staging 环境流量较低，掩盖了问题
   - 数据库连接指标警报阈值过高（90%）

3. **5 个为什么分析**：
   - 为什么服务失败？ → 数据库连接耗尽
   - 为什么连接耗尽？ → 每个请求打开新连接
   - 为什么每个请求打开新连接？ → 代码绕过了连接池
   - 为什么代码绕过连接池？ → 开发人员不熟悉代码库模式
   - 为什么开发人员不熟悉？ → 没有关于连接管理模式的文档

### 系统图
```

[客户端] → [负载均衡器] → [支付服务] → [数据库]
↓
连接池（损坏）
↓
直接连接（原因）

```

## 检测

### 有效的方面
- 部署后 8 分钟内错误率警报触发
- Grafana 仪表板清楚显示连接激增
- 值班响应迅速（2 分钟确认）

### 无效的方面
- 数据库连接指标警报阈值过高
- 没有与部署相关的警报
- 金丝雀部署本可以更早发现此问题

### 检测差距
部署于 14:23 完成，但首次警报直到 14:31 才触发（8 分钟）。部署感知警报本可以更快检测到问题。

## 响应

### 有效的方面
- 值班工程师快速识别出数据库是问题
- 回滚决策果断
- 事件频道中沟通清晰

### 可改进的方面
- 花费了 10 分钟将问题与最近部署关联
- 必须手动检查部署历史
- 回滚花费了 12 分钟（可以更快）

## 影响

### 客户影响
- 12,000 名独立客户受到影响
- 平均影响持续时间：35 分钟
- 847 个支持工单（受影响用户的 23%）
- 客户满意度评分下降 12 点

### 业务影响
- 预计收入损失：$45,000
- 支持成本：约 $2,500（代理时间）
- 工程时间：约 8 人时

### 技术影响
- 数据库主节点经历负载升高
- 事件期间一些副本延迟
- 对系统无永久性损害

## 经验教训

### 做得好的地方
1. 警报在客户报告之前检测到问题
2. 团队在压力下有效协作
3. 回滚程序运行顺利
4. 沟通清晰及时

### 做得不好的地方
1. 代码审查遗漏了关键更改
2. 连接池的测试覆盖差距
3. Staging 环境不能反映生产流量
4. 警报阈值未正确调整

### 运气好的地方
1. 事件发生在工作时间，团队全部可用
2. 数据库在没有完全失败的情况下处理了负载
3. 没有同时发生其他事件

## 行动项

| 优先级 | 行动 | 负责人 | 截止日期 | 工单 |
|----------|--------|-------|----------|--------|
| P0 | 为连接池行为添加集成测试 | @alice | 2024-01-22 | ENG-1234 |
| P0 | 将数据库连接警报阈值降低到 70% | @bob | 2024-01-17 | OPS-567 |
| P1 | 记录连接管理模式 | @alice | 2024-01-29 | DOC-89 |
| P1 | 实施与部署相关的警报 | @bob | 2024-02-05 | OPS-568 |
| P2 | 评估金丝雀部署策略 | @charlie | 2024-02-15 | ENG-1235 |
| P2 | 使用类生产流量对 staging 进行负载测试 | @dave | 2024-02-28 | QA-123 |

## 附录

### 支持数据

#### 错误率图
[链接到 Grafana 仪表板快照]

#### 数据库连接图
[链接到指标]

### 相关事件
- 2023-11-02：用户服务中的类似连接问题（POSTMORTEM-42）

### 参考资料
- [连接池最佳实践](internal-wiki/connection-pools)
- [部署运行手册](internal-wiki/deployment-runbook)
```

### 模板 2：5 个为什么分析

```markdown
# 5 个为什么分析：[事件]

## 问题陈述

由于数据库连接耗尽，支付服务经历 47 分钟中断。

## 分析

### 为什么 #1：为什么服务失败？

**答案**：数据库连接已耗尽，导致所有新请求失败。

**证据**：指标显示连接数为 100/100（最大值），500+ 待处理请求。

---

### 为什么 #2：为什么数据库连接耗尽？

**答案**：每个传入请求打开一个新的数据库连接，而不是使用连接池。

**证据**：代码差异显示使用直接的 `DriverManager.getConnection()` 而不是池化的 `DataSource`。

---

### 为什么 #3：为什么代码绕过了连接池？

**答案**：开发人员重构了存储库类，无意中更改了连接获取方法。

**证据**：PR #1234 显示了在修复不同 bug 时所做的更改。

---

### 为什么 #4：为什么代码审查没有发现这一点？

**答案**：审查者关注功能更改（bug 修复），没有注意到基础设施更改。

**证据**：审查评论只讨论业务逻辑。

---

### 为什么 #5：为什么没有针对此类更改的安全网？

**答案**：我们缺乏验证连接池行为的自动化测试，也缺乏关于连接模式的文档。

**证据**：测试套件没有连接处理的测试；wiki 没有关于数据库连接的文章。

## 识别的根本原因

1. **主要**：缺少基础设施行为的自动化测试
2. **次要**：架构模式的文档不足
3. **第三级**：代码审查清单不包括基础设施考虑因素

## 系统性改进

| 根本原因 | 改进 | 类型 |
| ------------- | --------------------------------- | ---------- |
| 缺少测试 | 添加基础设施行为测试 | 预防 |
| 缺少文档 | 记录连接模式 | 预防 |
| 审查差距 | 更新审查清单 | 检测 |
| 无金丝雀 | 实施金丝雀部署 | 缓解 |
```

### 模板 3：快速事后分析（次要事件）

```markdown
# 快速事后分析：[简短标题]

**日期**：2024-01-15 | **持续时间**：12 分钟 | **严重程度**：SEV3

## 发生了什么

由于缓存刷新后的缓存未命中风暴，API 延迟激增到 5 秒。

## 时间线

- 10:00 - 为配置更新启动缓存刷新
- 10:02 - 延迟警报触发
- 10:05 - 识别为缓存未命中风暴
- 10:08 - 启用缓存预热
- 10:12 - 延迟恢复正常

## 根本原因

为次要配置更新进行完全缓存刷新导致惊群效应。

## 修复

- 立即：启用缓存预热
- 长期：实施部分缓存失效（ENG-999）

## 经验教训

不要在生产环境中完全刷新缓存；使用定向失效。
```

## 促进指南

### 运行事后分析会议

```markdown
## 会议结构（60 分钟）

### 1. 开场（5 分钟）

- 提醒大家无责备文化
- "我们在这里学习，而不是责备"
- 审查会议规范

### 2. 时间线审查（15 分钟）

- 按时间顺序浏览事件
- 提出澄清问题
- 识别时间线中的差距

### 3. 分析讨论（20 分钟）

- 什么失败了？
- 为什么失败？
- 什么条件允许了这种情况？
- 什么可以防止它？

### 4. 行动项（15 分钟）

- 头脑风暴改进
- 按影响和工作量优先排序
- 分配负责人和截止日期

### 5. 结束（5 分钟）

- 总结关键学习
- 确认行动项负责人
- 如需要，安排后续跟进

## 促进技巧

- 保持讨论正轨
- 将责备重定向到系统
- 鼓励安静的参与者
- 记录不同意见
- 为切线话题设置时间限制
```

## 避免的反模式

| 反模式 | 问题 | 更好的方法 |
| ----------------------- | -------------------------- | ------------------------------- |
| **责备游戏** | 关闭学习 | 专注于系统 |
| **浅层分析** | 不能防止复发 | 问 5 次"为什么" |
| **无行动项** | 浪费时间 | 始终有具体的下一步 |
| **不切实际的行动** | 永远不会完成 | 范围到可完成的任务 |
| **无后续跟进** | 行动被遗忘 | 在工单系统中跟踪 |

## 最佳实践

### 应该做的

- **立即开始** - 记忆很快消退
- **具体** - 精确的时间、精确的错误
- **包括图表** - 视觉证据
- **分配负责人** - 没有孤立的行动项
- **广泛分享** - 组织学习

### 不应该做的

- **不要点名羞辱** - 永远不要
- **不要跳过小事件** - 它们揭示模式
- **不要让它成为责备文档** - 那会扼杀学习
- **不要制造忙碌工作** - 行动应该有意义
- **不要跳过后续跟进** - 验证行动已完成

## 资源

- [Google SRE - 事后分析文化](https://sre.google/sre-book/postmortem-culture/)
- [Etsy 的无责备事后分析](https://codeascraft.com/2012/05/22/blameless-postmortems/)
- [PagerDuty 事后分析指南](https://postmortems.pagerduty.com/)
